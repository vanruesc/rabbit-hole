<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src\volume\octree\volume.js - rabbit-hole</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="rabbit-hole" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/Action.html">Action</a></li>
                                <li><a href="../classes/Box.html">Box</a></li>
                                <li><a href="../classes/Box3.html">Box3</a></li>
                                <li><a href="../classes/Chunk.html">Chunk</a></li>
                                <li><a href="../classes/ChunkHelper.html">ChunkHelper</a></li>
                                <li><a href="../classes/ConstructiveSolidGeometry.html">ConstructiveSolidGeometry</a></li>
                                <li><a href="../classes/DensityFunction.html">DensityFunction</a></li>
                                <li><a href="../classes/Difference.html">Difference</a></li>
                                <li><a href="../classes/DualContouring.html">DualContouring</a></li>
                                <li><a href="../classes/Edge.html">Edge</a></li>
                                <li><a href="../classes/EdgeData.html">EdgeData</a></li>
                                <li><a href="../classes/Event.html">Event</a></li>
                                <li><a href="../classes/EventTarget.html">EventTarget</a></li>
                                <li><a href="../classes/Givens.html">Givens</a></li>
                                <li><a href="../classes/HermiteData.html">HermiteData</a></li>
                                <li><a href="../classes/History.html">History</a></li>
                                <li><a href="../classes/Intersection.html">Intersection</a></li>
                                <li><a href="../classes/IteratorResult.html">IteratorResult</a></li>
                                <li><a href="../classes/Material.html">Material</a></li>
                                <li><a href="../classes/Matrix3.html">Matrix3</a></li>
                                <li><a href="../classes/MeshTriplanarPhysicalMaterial.html">MeshTriplanarPhysicalMaterial</a></li>
                                <li><a href="../classes/Operation.html">Operation</a></li>
                                <li><a href="../classes/OperationType.html">OperationType</a></li>
                                <li><a href="../classes/Plane.html">Plane</a></li>
                                <li><a href="../classes/PriorityQueue.html">PriorityQueue</a></li>
                                <li><a href="../classes/QEFData.html">QEFData</a></li>
                                <li><a href="../classes/QEFSolver.html">QEFSolver</a></li>
                                <li><a href="../classes/Queue.html">Queue</a></li>
                                <li><a href="../classes/Reviver.html">Reviver</a></li>
                                <li><a href="../classes/RunLengthEncoder.html">RunLengthEncoder</a></li>
                                <li><a href="../classes/Scheduler.html">Scheduler</a></li>
                                <li><a href="../classes/Schur.html">Schur</a></li>
                                <li><a href="../classes/SDFType.html">SDFType</a></li>
                                <li><a href="../classes/SignedDistanceFunction.html">SignedDistanceFunction</a></li>
                                <li><a href="../classes/SingularValueDecomposition.html">SingularValueDecomposition</a></li>
                                <li><a href="../classes/Sphere.html">Sphere</a></li>
                                <li><a href="../classes/SurfaceExtractor.html">SurfaceExtractor</a></li>
                                <li><a href="../classes/SymmetricMatrix3.html">SymmetricMatrix3</a></li>
                                <li><a href="../classes/Task.html">Task</a></li>
                                <li><a href="../classes/Terrain.html">Terrain</a></li>
                                <li><a href="../classes/TerrainEvent.html">TerrainEvent</a></li>
                                <li><a href="../classes/ThreadPool.html">ThreadPool</a></li>
                                <li><a href="../classes/Torus.html">Torus</a></li>
                                <li><a href="../classes/Union.html">Union</a></li>
                                <li><a href="../classes/Vector3.html">Vector3</a></li>
                                <li><a href="../classes/Volume.html">Volume</a></li>
                                <li><a href="../classes/VolumeIterator.html">VolumeIterator</a></li>
                                <li><a href="../classes/VolumeModifier.html">VolumeModifier</a></li>
                                <li><a href="../classes/Voxel.html">Voxel</a></li>
                                <li><a href="../classes/VoxelBlock.html">VoxelBlock</a></li>
                                <li><a href="../classes/VoxelCell.html">VoxelCell</a></li>
                                <li><a href="../classes/Worker.html">Worker</a></li>
                                <li><a href="../classes/WorkerEvent.html">WorkerEvent</a></li>
                                <li><a href="../classes/WorkerTask.html">WorkerTask</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/core.html">core</a></li>
                                <li><a href="../modules/csg.html">csg</a></li>
                                <li><a href="../modules/events.html">events</a></li>
                                <li><a href="../modules/helpers.html">helpers</a></li>
                                <li><a href="../modules/isosurface.html">isosurface</a></li>
                                <li><a href="../modules/materials.html">materials</a></li>
                                <li><a href="../modules/math.html">math</a></li>
                                <li><a href="../modules/octree.html">octree</a></li>
                                <li><a href="../modules/rabbit-hole.html">rabbit-hole</a></li>
                                <li><a href="../modules/sdf.html">sdf</a></li>
                                <li><a href="../modules/volume.html">volume</a></li>
                                <li><a href="../modules/worker.html">worker</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: src\volume\octree\volume.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
import { Octree } from &quot;sparse-octree&quot;;
import { Box3 } from &quot;../../math/box3.js&quot;;
import { OperationType } from &quot;../csg/operation-type.js&quot;;
import { Chunk } from &quot;./chunk.js&quot;;
import { VolumeIterator } from &quot;./volume-iterator.js&quot;;

/**
 * Rounds the given number up to the next power of two.
 *
 * @method ceil2
 * @private
 * @static
 * @param {Number} n - A number.
 * @return {Number} The next power of two.
 */

function ceil2(n) { return Math.pow(2, Math.max(0, Math.ceil(Math.log2(n)))); }

/**
 * A cubic octree that maintains volume chunks.
 *
 * @class Volume
 * @submodule octree
 * @extends Octree
 * @implements Iterable
 * @constructor
 * @param {Number} [chunkSize=32] - The size of leaf chunks. Will be rounded up to the next power of two.
 * @param {Number} [resolution=32] - The data resolution of leaf chunks. Will be rounded up to the next power of two. The upper limit is 256.
 */

export class Volume extends Octree {

	constructor(chunkSize = 32, resolution = 32) {

		super();

		this.root = new Chunk();

		/**
		 * The size of a volume chunk.
		 *
		 * @property chunkSize
		 * @type Number
		 * @private
		 * @default 32
		 */

		this.chunkSize = Math.max(1, ceil2(chunkSize));

		this.min.subScalar(this.chunkSize * 2);
		this.size = this.chunkSize * 4;

		this.root.resolution = ceil2(resolution);

	}

	/**
	 * The size of the root octant.
	 *
	 * @property size
	 * @type Number
	 */

	get size() { return this.root.size; }

	set size(x) { this.root.size = x; }

	/**
	 * The resolution of the volume data.
	 *
	 * @property resolution
	 * @type Number
	 */

	get resolution() { return this.root.resolution; }

	/**
	 * Edits this volume.
	 *
	 * @method edit
	 * @param {SignedDistanceFunction} sdf - An SDF.
	 * @return {Array} The chunks that lie inside the operation&#x27;s region, including newly created ones.
	 */

	edit(sdf) {

		const heap = [this.root];
		const box = new Box3();
		const region = sdf.completeBoundingBox;

		let result = [];
		let octant, children;

		if(sdf.operation === OperationType.UNION) {

			this.expand(region);

			// Find and create leaf chunks.
			while(heap.length &gt; 0) {

				octant = heap.pop();
				children = octant.children;

				box.min = octant.min;
				box.max = octant.max;

				if(region.intersectsBox(box)) {

					if(children !== null) {

						heap.push(...children);

					} else if(octant.size &gt; this.chunkSize) {

						octant.split();
						heap.push(...octant.children);

					} else {

						result.push(octant);

					}

				}

			}

		} else if(sdf.operation === OperationType.DIFFERENCE) {

			// Chunks that don&#x27;t exist can&#x27;t become more empty.
			result = this.cull(region);

		} else {

			// Intersections affect all chunks.
			result = this[Symbol.iterator]();

		}

		return result;

	}

	/**
	 * Expands the volume to include the given region.
	 *
	 * @method expand
	 * @private
	 * @param {Box3} region - A region.
	 */

	expand(region) {

		const min = region.min;
		const max = region.max;

		const m = Math.max(
			Math.max(Math.max(Math.abs(min.x), Math.abs(min.y)), Math.abs(min.z)),
			Math.max(Math.max(Math.abs(max.x), Math.abs(max.y)), Math.abs(max.z))
		);

		let s = this.size / 2;
		let originalChildren = this.children;

		let n, i;

		if(m &gt; s) {

			// Find an appropriate target size.
			n = ceil2(Math.ceil(m / this.chunkSize) * this.chunkSize);

			if(originalChildren === null) {

				// Expand the root&#x27;s boundaries.
				this.min.set(-n, -n, -n);
				this.size = 2 * n;

			} else {

				// Repeatedly double the octree size and create intermediate octants.
				while(s &lt; n) {

					s = this.size;

					this.min.multiplyScalar(2);
					this.size *= 2;

					// Create new children.
					this.root.split();

					// Connect them with the old children.
					for(i = 0; i &lt; 8; ++i) {

						// But only if they actually contain deeper structures.
						if(originalChildren[i].children !== null) {

							this.children[i].split([originalChildren[i]]);

						}

					}

					originalChildren = this.children;

				}

			}

		}

	}

	/**
	 * Removes the given chunk and shrinks the volume if possible.
	 *
	 * @method prune
	 * @param {Chunk} chunk - A chunk to remove.
	 * @todo
	 */

	prune(chunk) {

	}

	/**
	 * Returns a volume iterator that finds chunks inside a specific region.
	 *
	 * @method chunks
	 * @param {Frustum} [region] - A region.
	 * @return {VolumeIterator} An iterator.
	 */

	chunks(region) {

		const iterator = new VolumeIterator(this, true);

		if(region !== undefined) {

			iterator.region.copy(region);

		}

		return iterator;

	}

	/**
	 * Returns a volume iterator that traverses the entire octree.
	 *
	 * @method Symbol.iterator
	 * @return {VolumeIterator} An iterator.
	 */

	[Symbol.iterator]() {

		return new VolumeIterator(this);

	}

	/**
	 * Loads a volume.
	 *
	 * @method load
	 * @param {String} data - The volume data to import.
	 */

	load(data) {

		Chunk.resolution = data.resolution;
		this.chunkSize = data.chunkSize;
		this.root = data.root;

	}

	/**
	 * Creates a compact representation of the current volume data.
	 *
	 * @method toJSON
	 * @return {Object} A concise representation of this volume.
	 */

	toJSON() {

		return {
			resolution: Chunk.resolution,
			chunkSize: this.chunkSize,
			root: this.root
		};

	}

}

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
