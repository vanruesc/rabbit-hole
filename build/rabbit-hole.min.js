/**
 * rabbit-hole v0.0.0 build Aug 03 2017
 * https://github.com/vanruesc/rabbit-hole
 * Copyright 2017 Raoul van Rüschen, Zlib
 */

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("three")):"function"==typeof define&&define.amd?define(["exports","three"],e):e(t.RABBITHOLE={},t.THREE)}(this,function(t,e){"use strict";function n(t,e,n,i,r,s){var a=0;return t>e&&t>n?(r<t&&(a|=2),s<t&&(a|=1)):e>n?(i<e&&(a|=4),s<e&&(a|=1)):(i<n&&(a|=4),r<n&&(a|=2)),a}function i(t,e,n,i){var r=void 0,s=0;return e<n?(r=e,s=0):(r=n,s=1),i<r&&(s=2),at[t][s]}function r(t,e,s,a,o,u,l,h,c){var d=t.children,v=void 0,f=void 0,y=void 0,m=void 0;if(o>=0&&u>=0&&l>=0)if(null===d)c.push(t);else{v=n(e,s,a,f=.5*(e+o),y=.5*(s+u),m=.5*(a+l));do{switch(v){case 0:r(d[st[8]],e,s,a,f,y,m,h,c),v=i(v,f,y,m);break;case 1:r(d[st[8]^st[1]],e,s,m,f,y,l,h,c),v=i(v,f,y,l);break;case 2:r(d[st[8]^st[2]],e,y,a,f,u,m,h,c),v=i(v,f,u,m);break;case 3:r(d[st[8]^st[3]],e,y,m,f,u,l,h,c),v=i(v,f,u,l);break;case 4:r(d[st[8]^st[4]],f,s,a,o,y,m,h,c),v=i(v,o,y,m);break;case 5:r(d[st[8]^st[5]],f,s,m,o,y,l,h,c),v=i(v,o,y,l);break;case 6:r(d[st[8]^st[6]],f,y,a,o,u,m,h,c),v=i(v,o,u,m);break;case 7:r(d[st[8]^st[7]],f,y,m,o,u,l,h,c),v=8}}while(v<8)}}function s(t){var e=t.children,n=0,i=void 0,r=void 0,a=void 0;if(null!==e)for(i=0,r=e.length;i<r;++i)(a=1+s(e[i]))>n&&(n=a);return n}function a(t,e,n){var i=t.children,r=void 0,s=void 0;if(ut.min=t.min,ut.max=t.max,e.intersectsBox(ut))if(null!==i)for(r=0,s=i.length;r<s;++r)a(i[r],e,n);else n.push(t)}function o(t,e,n,i){var r=t.children,s=void 0,a=void 0;if(n===e)i.push(t);else if(null!==r)for(++n,s=0,a=r.length;s<a;++s)o(r[s],e,n,i)}function u(t){var e=t.children,n=0,i=void 0,r=void 0;if(null!==e)for(i=0,r=e.length;i<r;++i)n+=u(e[i]);else null!==t.points&&(n=t.points.length);return n}function l(t,e,n,i,r,s,a){var o=t.children,u=!1,h=!1,c=void 0,d=void 0;if(t.contains(e,r)){if(null===o){if(null===t.points)t.points=[],t.data=[];else for(c=0,d=t.points.length;!u&&c<d;++c)u=t.points[c].equals(e);u?(t.data[c-1]=n,h=!0):t.points.length<s||i===a?(t.points.push(e.clone()),t.data.push(n),h=!0):(t.split(),t.redistribute(r),o=t.children)}if(null!==o)for(++i,c=0,d=o.length;!h&&c<d;++c)h=l(o[c],e,n,i,r,s,a)}return h}function h(t,e,n,i,r){var s=t.children,a=!1,o=void 0,l=void 0,c=void 0,d=void 0,v=void 0;if(t.contains(n,i))if(null!==s)for(o=0,l=s.length;!a&&o<l;++o)a=h(s[o],t,n,i,r);else if(null!==t.points)for(c=t.points,d=t.data,o=0,l=c.length;!a&&o<l;++o)c[o].equals(n)&&(o<(v=l-1)&&(c[o]=c[v],d[o]=d[v]),c.pop(),d.pop(),null!==e&&u(e)<=r&&e.merge(),a=!0);return a}function c(t,e,n,i){var r=t.children,s=null,a=void 0,o=void 0,u=void 0;if(t.contains(e,n))if(null!==r)for(a=0,o=r.length;null===s&&a<o;++a)s=c(r[a],e,n,i);else for(a=0,o=(u=t.points).length;null===s&&a<o;++a)e.distanceToSquared(u[a])<=i&&(s=t.data[a]);return s}function d(t,e,n,i){var r=t.points,s=t.children,a=null,o=n,u=void 0,l=void 0,h=void 0,c=void 0,v=void 0,f=void 0,y=void 0;if(null!==s)for(u=0,l=(v=s.map(function(t){return{octant:t,distance:t.distanceToCenterSquared(e)}}).sort(function(t,e){return t.distance-e.distance})).length;u<l;++u)(f=v[u].octant).contains(e,o)&&null!==(y=d(f,e,o,i))&&(c=y.point.distanceToSquared(e),(!i||c>0)&&c<o&&(o=c,a=y));else if(null!==r)for(u=0,l=r.length;u<l;++u)h=r[u],c=e.distanceToSquared(h),(!i||c>0)&&c<o&&(o=c,a={point:h.clone(),data:t.data[u]});return a}function v(t,e,n,i,r){var s=t.points,a=t.children,o=n*n,u=void 0,l=void 0,h=void 0,c=void 0,d=void 0;if(null!==a)for(u=0,l=a.length;u<l;++u)(d=a[u]).contains(e,n)&&v(d,e,n,i,r);else if(null!==s)for(u=0,l=s.length;u<l;++u)h=s[u],c=e.distanceToSquared(h),(!i||c>0)&&c<=o&&r.push({point:h.clone(),data:t.data[u]})}function f(t){return Math.pow(2,Math.max(0,Math.ceil(Math.log2(t))))}function y(t,e,n){var i=void 0,r=void 0,s=void 0;0===e?($t.c=1,$t.s=0):(i=(n-t)/(2*e),r=Math.sqrt(1+i*i),s=1/(i>=0?i+r:i-r),$t.c=1/Math.sqrt(1+s*s),$t.s=s*$t.c)}function m(t,e){0!==t.elements[1]&&Qt.rot01Post(e,Kt.rot01(t))}function p(t,e){0!==t.elements[2]&&Qt.rot02Post(e,Kt.rot02(t))}function g(t,e){0!==t.elements[4]&&Qt.rot12Post(e,Kt.rot12(t))}function x(t,e,n,i,r){var s=i*e.copy(t).norm(),a=void 0;for(a=0;a<r&&e.off()>s;++a)m(e,n),p(e,n),g(e,n)}function k(t,e){var n=1/t;return Math.abs(t)<e||Math.abs(n)<e?0:n}function b(t,e,n,i){var r=t.elements,s=e.elements,a=n.elements,o=s[0],u=s[3],l=s[5],h=k(o,i),c=k(u,i),d=k(l,i),v=3-((0===h)+(0===c)+(0===d)),f=a[0],y=a[3],m=a[6],p=a[1],g=a[4],x=a[7],b=a[2],w=a[5],_=a[8];return r[0]=f*h*f+y*c*y+m*d*m,r[3]=f*h*p+y*c*g+m*d*x,r[6]=f*h*b+y*c*w+m*d*_,r[1]=r[3],r[4]=p*h*p+g*c*g+x*d*x,r[7]=p*h*b+g*c*w+x*d*_,r[2]=r[6],r[5]=r[7],r[8]=b*h*b+w*c*w+_*d*_,v}function w(t,e,n,i,r){var s=t+1,a=s*s,o=new ie,u=void 0,l=void 0,h=void 0,c=void 0,d=void 0;for(u=0,d=0;d<8;++d)c=(i+(h=K[d])[2])*a+(n+h[1])*s+(e+h[0]),u|=Math.min(r[c],ct.SOLID)<<d;for(l=0,d=0;d<12;++d)(u>>tt[d][0]&1)!==(u>>tt[d][1]&1)&&++l;return o.materials=u,o.edgeCount=l,o.qefData=new ne,o}function _(t,e){var n=t.size,i=t.resolution,r=new W(0,0,0),s=new W(i,i,i),a=new G(t.min,t.max);return e.type!==U.INTERSECTION&&(e.boundingBox.intersectsBox(a)?(r.copy(e.boundingBox.min).max(a.min).sub(a.min),r.x=Math.ceil(r.x*i/n),r.y=Math.ceil(r.y*i/n),r.z=Math.ceil(r.z*i/n),s.copy(e.boundingBox.max).min(a.max).sub(a.min),s.x=Math.floor(s.x*i/n),s.y=Math.floor(s.y*i/n),s.z=Math.floor(s.z*i/n)):(r.set(i,i,i),s.set(0,0,0))),new G(r,s)}function z(t,e,n,i,r){var s=t.resolution+1,a=s*s,o=r.max.x,u=r.max.y,l=r.max.z,h=void 0,c=void 0,d=void 0;for(d=r.min.z;d<=l;++d)for(c=r.min.y;c<=u;++c)for(h=r.min.x;h<=o;++h)e.updateMaterialIndex(d*a+c*s+h,n,i)}function A(t,e,n,i){var r=t.size,s=t.resolution,a=s+1,o=a*a,u=n.materialIndices,l=t.min,h=new W,c=new W,d=i.max.x,v=i.max.y,f=i.max.z,y=void 0,m=0,p=void 0,g=void 0,x=void 0;for(x=i.min.z;x<=f;++x)for(h.z=x*r/s,g=i.min.y;g<=v;++g)for(h.y=g*r/s,p=i.min.x;p<=d;++p)h.x=p*r/s,(y=e.generateMaterialIndex(c.addVectors(l,h)))!==ct.AIR&&(u[x*o+g*a+p]=y,++m);n.materials=m}function M(t,e,n,i){var r=t.resolution+1,s=new Uint32Array([1,r,r*r]),a=n.materialIndices,o=new Gt,u=new Gt,l=i.edgeData,h=n.edgeData,c=dt.calculate1DEdgeCount(t.resolution),d=new dt(Math.min(c,h.edges[0].length+l.edges[0].length),Math.min(c,h.edges[1].length+l.edges[1].length),Math.min(c,h.edges[2].length+l.edges[2].length)),v=new Uint32Array(3),f=void 0,y=void 0,m=void 0,p=void 0,g=void 0,x=void 0,k=void 0,b=void 0,w=void 0,_=void 0,z=void 0,A=void 0,M=void 0,S=void 0,E=void 0,P=void 0,O=void 0,D=void 0,I=void 0,C=void 0,N=void 0,T=void 0;for(O=0,D=0;D<3;O=0,++D){for(f=l.edges[D],p=h.edges[D],k=d.edges[D],y=l.zeroCrossings[D],g=h.zeroCrossings[D],b=d.zeroCrossings[D],m=l.normals[D],x=h.normals[D],w=d.normals[D],N=f.length,T=p.length,I=0,C=0;I<N;++I)if(_=f[I],z=_+s[D],S=a[_],E=a[z],S!==E&&(S===ct.AIR||E===ct.AIR)){for(o.t=y[I],o.n.x=m[3*I],o.n.y=m[3*I+1],o.n.z=m[3*I+2],e.type===U.DIFFERENCE&&o.n.negate(),P=o;C<T&&p[C]<=_;)M=(A=p[C])+s[D],u.t=g[C],u.n.x=x[3*C],u.n.y=x[3*C+1],u.n.z=x[3*C+2],S=a[A],A<_?S===(E=a[M])||S!==ct.AIR&&E!==ct.AIR||(k[O]=A,b[O]=u.t,w[3*O]=u.n.x,w[3*O+1]=u.n.y,w[3*O+2]=u.n.z,++O):P=e.selectEdge(u,o,S===ct.SOLID),++C;k[O]=_,b[O]=P.t,w[3*O]=P.n.x,w[3*O+1]=P.n.y,w[3*O+2]=P.n.z,++O}for(;C<T;)M=(A=p[C])+s[D],(S=a[A])===(E=a[M])||S!==ct.AIR&&E!==ct.AIR||(k[O]=A,b[O]=g[C],w[3*O]=x[3*C],w[3*O+1]=x[3*C+1],w[3*O+2]=x[3*C+2],++O),++C;v[D]=O}return{edgeData:d,lengths:v}}function S(t,e,n,i){var r=t.size,s=t.resolution,a=s+1,o=a*a,u=new Uint32Array([1,a,o]),l=n.materialIndices,h=t.min,c=new W,d=new W,v=new Gt,f=new dt(dt.calculate1DEdgeCount(s)),y=new Uint32Array(3),m=void 0,p=void 0,g=void 0,x=void 0,k=void 0,b=void 0,w=void 0,_=void 0,z=void 0,A=void 0,M=void 0,S=void 0,E=void 0,P=void 0,U=void 0,O=void 0,D=void 0,I=void 0;for(P=4,S=0,E=0;E<3;P>>=1,S=0,++E){switch(U=K[P],m=f.edges[E],p=f.zeroCrossings[E],g=f.normals[E],b=i.min.x,z=i.max.x,w=i.min.y,A=i.max.y,_=i.min.z,M=i.max.z,E){case 0:b=Math.max(b-1,0),z=Math.min(z,s-1);break;case 1:w=Math.max(w-1,0),A=Math.min(A,s-1);break;case 2:_=Math.max(_-1,0),M=Math.min(M,s-1)}for(I=_;I<=M;++I)for(D=w;D<=A;++D)for(O=b;O<=z;++O)k=(x=I*o+D*a+O)+u[E],l[x]!==l[k]&&(c.set(O*r/s,D*r/s,I*r/s),d.set((O+U[0])*r/s,(D+U[1])*r/s,(I+U[2])*r/s),v.a.addVectors(h,c),v.b.addVectors(h,d),e.generateEdge(v),m[S]=x,p[S]=v.t,g[3*S]=v.n.x,g[3*S+1]=v.n.y,g[3*S+2]=v.n.z,++S);y[E]=S}return{edgeData:f,lengths:y}}function E(t,e,n,i){var r=_(t,e),s=void 0,a=void 0,o=void 0,u=void 0,l=!1;if(e.type===U.DENSITY_FUNCTION?A(t,e,n,r):n.empty?e.type===U.UNION&&(n.set(i),l=!0):n.full&&e.type===U.UNION||z(t,e,n,i,r),!l&&!n.empty&&!n.full){for(a=(s=e.type===U.DENSITY_FUNCTION?S(t,e,n,r):M(t,e,n,i)).edgeData,o=s.lengths,u=0;u<3;++u)a.edges[u]=a.edges[u].slice(0,o[u]),a.zeroCrossings[u]=a.zeroCrossings[u].slice(0,o[u]),a.normals[u]=a.normals[u].slice(0,3*o[u]);n.edgeData=a}}function P(t,e){var n=e.children,i=void 0,r=void 0,s=void 0,a=void 0;for(e.type===U.DENSITY_FUNCTION&&E(t,e,i=new yt),s=0,a=n.length;s<a&&(r=P(t,n[s]),void 0===i?i=r:null!==r?null===i?e.type===U.UNION&&(i=r):E(t,e,i,r):e.type===U.INTERSECTION&&(i=null),null!==i||e.type===U.UNION);++s);return null!==i&&i.empty?null:i}var U={UNION:"csg.union",DIFFERENCE:"csg.difference",INTERSECTION:"csg.intersection",DENSITY_FUNCTION:"csg.densityfunction"},O=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},D=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),I=function t(e,n,i){null===e&&(e=Function.prototype);var r=Object.getOwnPropertyDescriptor(e,n);if(void 0===r){var s=Object.getPrototypeOf(e);return null===s?void 0:t(s,n,i)}if("value"in r)return r.value;var a=r.get;if(void 0!==a)return a.call(i)},C=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},N=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},T=function(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)},R=function(){function t(){O(this,t),this.elements=[]}return D(t,[{key:"push",value:function(t){return this.elements.push(t)}},{key:"pop",value:function(){return this.elements.pop()}},{key:"combine",value:function(){var t=this.elements,e=null,n=null,i=void 0,r=void 0;for(i=0,r=t.length;i<r;++i)if(n=t[i],null!==e)switch(n.operation){case U.UNION:e.union(n);break;case U.DIFFERENCE:e.subtract(n);break;case U.INTERSECTION:e.intersect(n)}else e=n;return e}},{key:"clear",value:function(){this.elements=[]}}]),t}(),L=function(){function t(){O(this,t),this.elements=[],this.head=0,this.size=0}return D(t,[{key:"add",value:function(t){var e=this.elements.length;return this.elements.push(t),++this.size,e}},{key:"remove",value:function(t){var e=this.elements,n=e.length,i=null;if(this.size>0&&t>=0&&t<n&&null!==(i=e[t]))if(e[t]=null,--this.size>0){for(;this.head<n&&null===e[this.head];)++this.head;this.head===n&&this.clear()}else this.clear();return i}},{key:"peek",value:function(){return this.size>0?this.elements[this.head]:null}},{key:"poll",value:function(){var t=this.elements,e=t.length,n=null;if(this.size>0){for(n=t[this.head++];this.head<e&&null===t[this.head];)++this.head;this.head===e?this.clear():--this.size}return n}},{key:"clear",value:function(){this.elements=[],this.head=0,this.size=0}}]),t}(),F=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;O(this,e);var n=N(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));for(t=Math.max(1,t);t-- >0;)n.elements.push(new L);return n}return C(e,L),D(e,[{key:"add",value:function(t,e){var n=-1;return e>=0&&e<this.elements.length&&(n=this.elements[e].add(t),e>this.head&&(this.head=e),++this.size),n}},{key:"remove",value:function(t,e){var n=null;if(e>=0&&e<this.elements.length&&null!==(n=this.elements[e].remove(t)))for(--this.size;this.head>0&&0===this.elements[this.head].size;)--this.head;return n}},{key:"peek",value:function(){return this.size>0?this.elements[this.head].peek():null}},{key:"poll",value:function(){var t=null;if(this.size>0)for(t=this.elements[this.head].poll(),--this.size;this.head>0&&0===this.elements[this.head].size;)--this.head;return t}},{key:"clear",value:function(){var t=void 0;for(t=this.elements.length-1;t>=0;--t)this.elements[t].clear();this.head=0,this.size=0}},{key:"tiers",get:function(){return this.elements.length}}]),e}(),B=function(){function t(){O(this,t)}return D(t,null,[{key:"encode",value:function(t){var e=[],n=[],i=t[0],r=1,s=void 0,a=void 0;for(s=1,a=t.length;s<a;++s)i!==t[s]?(e.push(r),n.push(i),i=t[s],r=1):++r;return e.push(r),n.push(i),{runLengths:e,data:n}}},{key:"decode",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],i=void 0,r=void 0,s=void 0,a=void 0,o=void 0,u=0;for(r=0,a=e.length;r<a;++r)for(i=e[r],s=0,o=t[r];s<o;++s)n[u++]=i;return n}}]),t}(),V=function(t){function e(t){O(this,e);var n=N(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n.registry=new WeakMap,n.maxPriority=n.tiers-1,n}return C(e,F),D(e,[{key:"cancel",value:function(t){var e=this.registry.has(t),n=void 0;return e&&(n=this.registry.get(t),this.remove(n.index,n.priority),this.registry.delete(t)),e}},{key:"schedule",value:function(t,e){var n=!this.registry.has(t);return n&&(null!==e&&(this.remove(e.index,e.priority),this.registry.delete(t)),e.index=this.add(e,e.priority),this.registry.set(t,e)),n}},{key:"hasTask",value:function(t){return this.registry.has(t)}},{key:"getTask",value:function(t){return this.registry.get(t)}},{key:"poll",value:function(){var t=I(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"poll",this).call(this);return null!==t&&this.registry.delete(t.chunk),t}},{key:"clear",value:function(){I(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"clear",this).call(this),this.registry=new WeakMap}}]),e}(),j=function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;O(this,t),this.priority=e,this.index=-1},q=function t(e){O(this,t),this.type=e,this.target=null},Y=function(){function t(){O(this,t),this.listenerFunctions=new Map,this.listenerObjects=new Map}return D(t,[{key:"addEventListener",value:function(t,e){var n="function"==typeof e?this.listenerFunctions:this.listenerObjects;n.has(t)?n.get(t).add(e):n.set(t,new Set([e]))}},{key:"removeEventListener",value:function(t,e){var n="function"==typeof e?this.listenerFunctions:this.listenerObjects,i=void 0;n.has(t)&&((i=n.get(t)).delete(e),0===i.size&&n.delete(t))}},{key:"dispatchEvent",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this,n=e.listenerFunctions,i=e.listenerObjects,r=void 0;if(t.target=e,n.has(t.type)){r=n.get(t.type);var s=!0,a=!1,o=void 0;try{for(var u,l=r[Symbol.iterator]();!(s=(u=l.next()).done);s=!0)u.value.call(e,t)}catch(t){a=!0,o=t}finally{try{!s&&l.return&&l.return()}finally{if(a)throw o}}}if(i.has(t.type)){r=i.get(t.type);var h=!0,c=!1,d=void 0;try{for(var v,f=r[Symbol.iterator]();!(h=(v=f.next()).done);h=!0)v.value.handleEvent(t)}catch(t){c=!0,d=t}finally{try{!h&&f.return&&f.return()}finally{if(c)throw d}}}}}]),t}(),H="#define PHYSICAL\r\n\r\nuniform vec3 diffuse;\r\nuniform vec3 emissive;\r\nuniform float roughness;\r\nuniform float metalness;\r\nuniform float opacity;\r\n\r\n#ifndef STANDARD\r\n\tuniform float clearCoat;\r\n\tuniform float clearCoatRoughness;\r\n#endif\r\n\r\nvarying vec3 vViewPosition;\r\n\r\n#ifndef FLAT_SHADED\r\n\r\n\tvarying vec3 vNormal;\r\n\r\n#endif\r\n\r\n#include <common>\r\n#include <packing>\r\n#include <color_pars_fragment>\r\n#include <map_triplanar_pars_fragment>\r\n#include <alphamap_pars_fragment>\r\n#include <specularmap_pars_fragment>\r\n#include <lightmap_pars_fragment>\r\n#include <emissivemap_pars_fragment>\r\n#include <envmap_pars_fragment>\r\n#include <fog_pars_fragment>\r\n#include <bsdfs>\r\n#include <cube_uv_reflection_fragment>\r\n#include <lights_pars>\r\n#include <lights_physical_pars_fragment>\r\n#include <shadowmap_pars_fragment>\r\n#include <triplanar_pars_fragment>\r\n#include <normalmap_triplanar_pars_fragment>\r\n#include <roughnessmap_pars_fragment>\r\n#include <metalnessmap_pars_fragment>\r\n#include <logdepthbuf_pars_fragment>\r\n#include <clipping_planes_pars_fragment>\r\n\r\nvoid main() {\r\n\r\n\t#include <clipping_planes_fragment>\r\n\r\n\tvec4 diffuseColor = vec4( diffuse, opacity );\r\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\r\n\tvec3 totalEmissiveRadiance = emissive;\r\n\r\n\t#include <logdepthbuf_fragment>\r\n\t#include <normal_triplanar_fragment>\r\n\t#include <map_triplanar_fragment>\r\n\t#include <color_fragment>\r\n\t#include <alphamap_triplanar_fragment>\r\n\t#include <alphatest_fragment>\r\n\t#include <specularmap_triplanar_fragment>\r\n\t#include <roughnessmap_triplanar_fragment>\r\n\t#include <metalnessmap_triplanar_fragment>\r\n\t#include <emissivemap_triplanar_fragment>\r\n\r\n\t// accumulation\r\n\t#include <lights_physical_fragment>\r\n\t#include <lights_template>\r\n\r\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\r\n\r\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\r\n\r\n\t#include <premultiplied_alpha_fragment>\r\n\t#include <tonemapping_fragment>\r\n\t#include <encodings_fragment>\r\n\t#include <fog_fragment>\r\n\r\n}\r\n",Z="#define PHYSICAL\r\n\r\nvarying vec3 vViewPosition;\r\n\r\n#ifndef FLAT_SHADED\r\n\r\n\tvarying vec3 vNormal;\r\n\r\n#endif\r\n\r\n#include <common>\r\n#include <uv_pars_vertex> // offsetRepeat\r\n#include <color_pars_vertex>\r\n#include <fog_pars_vertex>\r\n#include <morphtarget_pars_vertex>\r\n#include <skinning_pars_vertex>\r\n#include <shadowmap_pars_vertex>\r\n#include <logdepthbuf_pars_vertex>\r\n#include <clipping_planes_pars_vertex>\r\n#include <triplanar_pars_vertex>\r\n\r\nvoid main() {\r\n\r\n\t#include <color_vertex>\r\n\r\n\t#include <beginnormal_vertex>\r\n\t#include <morphnormal_vertex>\r\n\t#include <skinbase_vertex>\r\n\t#include <skinnormal_vertex>\r\n\t#include <defaultnormal_vertex>\r\n\r\n#ifndef FLAT_SHADED // Normal computed with derivatives when FLAT_SHADED\r\n\r\n\tvNormal = normalize( transformedNormal );\r\n\r\n#endif\r\n\r\n\t#include <begin_vertex>\r\n\t#include <morphtarget_vertex>\r\n\t#include <skinning_vertex>\r\n\t#include <project_vertex>\r\n\t#include <logdepthbuf_vertex>\r\n\t#include <clipping_planes_vertex>\r\n\r\n\tvViewPosition = - mvPosition.xyz;\r\n\r\n\t#include <worldpos_vertex>\r\n\t#include <shadowmap_vertex>\r\n\t#include <fog_vertex>\r\n\t#include <triplanar_vertex>\r\n\r\n}\r\n";Object.assign(e.ShaderChunk,{alphamap_triplanar_fragment:"#ifdef USE_ALPHAMAP\r\n\r\n\tdiffuseColor.a *= t3( alphaMap ).g;\r\n\r\n#endif\r\n",emissivemap_triplanar_fragment:"#ifdef USE_EMISSIVEMAP\r\n\r\n\tvec4 emissiveColor = t3( emissiveMap );\r\n\r\n\temissiveColor.rgb = emissiveMapTexelToLinear( emissiveColor ).rgb;\r\n\r\n\ttotalEmissiveRadiance *= emissiveColor.rgb;\r\n\r\n#endif\r\n",map_triplanar_pars_fragment:"#ifdef USE_MAP\r\n\r\n\tuniform sampler2D map;\r\n\r\n\t#ifdef USE_MAP_Y\r\n\r\n\t\tuniform sampler2D mapY;\r\n\r\n\t#endif\r\n\r\n\t#ifdef USE_MAP_Z\r\n\r\n\t\tuniform sampler2D mapZ;\r\n\r\n\t#endif\r\n\r\n#endif\r\n",map_triplanar_fragment:"#ifdef USE_MAP\r\n\r\n\t#ifdef USE_MAP_Z\r\n\r\n\t\tvec4 texelColor = t3( map, mapY, mapZ );\r\n\r\n\t#elif USE_MAP_Y\r\n\r\n\t\tvec4 texelColor = t3( map, mapY );\r\n\r\n\t#else\r\n\r\n\t\tvec4 texelColor = t3( map );\r\n\r\n\t#endif\r\n\r\n\ttexelColor = mapTexelToLinear( texelColor );\r\n\tdiffuseColor *= texelColor;\r\n\r\n#endif\r\n",metalnessmap_triplanar_fragment:"float metalnessFactor = metalness;\r\n\r\n#ifdef USE_METALNESSMAP\r\n\r\n\tvec4 texelMetalness = t3( metalnessMap );\r\n\tmetalnessFactor *= texelMetalness.r;\r\n\r\n#endif\r\n",normal_triplanar_fragment:"#ifdef FLAT_SHADED\r\n\r\n\t// Workaround for Adreno/Nexus5 not able able to do dFdx( vViewPosition ) ...\r\n\r\n\tvec3 fdx = vec3( dFdx( vViewPosition.x ), dFdx( vViewPosition.y ), dFdx( vViewPosition.z ) );\r\n\tvec3 fdy = vec3( dFdy( vViewPosition.x ), dFdy( vViewPosition.y ), dFdy( vViewPosition.z ) );\r\n\tvec3 normal = normalize( cross( fdx, fdy ) );\r\n\r\n#else\r\n\r\n\tvec3 normal = normalize( vNormal );\r\n\r\n\t#ifdef DOUBLE_SIDED\r\n\r\n\t\tnormal = normal * ( float( gl_FrontFacing ) * 2.0 - 1.0 );\r\n\r\n\t#endif\r\n\r\n#endif\r\n\r\n#ifdef USE_NORMALMAP\r\n\r\n\tnormal = perturbNormal2Arb( normal );\r\n\r\n#endif\r\n",normalmap_triplanar_pars_fragment:"#ifdef USE_NORMALMAP\r\n\r\n\tuniform sampler2D normalMap;\r\n\tuniform vec2 normalScale;\r\n\r\n\t#ifdef USE_NORMALMAP_Y\r\n\r\n\t\tuniform sampler2D normalMapY;\r\n\r\n\t#endif\r\n\r\n\t#ifdef USE_NORMALMAP_Z\r\n\r\n\t\tuniform sampler2D normalMapZ;\r\n\r\n\t#endif\r\n\r\n\t// Triplanar Tangent Space Normal Mapping\r\n\t// Jaume Sánchez (https://www.clicktorelease.com/code/bumpy-metaballs/)\r\n\t// Mel (http://irrlicht.sourceforge.net/forum/viewtopic.php?t=48043)\r\n\r\n\tvec3 perturbNormal2Arb( vec3 normal ) {\r\n\r\n\t\t// Not sure why this doesn't work. Needs more testing!\r\n\t\t/*vec3 tangentX = vec3( normal.x, - normal.z, normal.y );\r\n\t\tvec3 tangentY = vec3( normal.z, normal.y, - normal.x );\r\n\t\tvec3 tangentZ = vec3( - normal.y, normal.x, normal.z );\r\n\r\n\t\tvec3 tangent = (\r\n\t\t\ttangentX * vBlend.x +\r\n\t\t\ttangentY * vBlend.y +\r\n\t\t\ttangentZ * vBlend.z\r\n\t\t); \r\n\r\n\t\tmat3 tsb = mat3(\r\n\t\t\tnormalize( tangent ),\r\n\t\t\tnormalize( cross( normal, tangent ) ),\r\n\t\t\tnormalize( normal )\r\n\t\t);*/\r\n\r\n\t\tmat3 tbn = mat3(\r\n\t\t\tnormalize( vec3( normal.y + normal.z, 0.0, normal.x ) ),\r\n\t\t\tnormalize( vec3( 0.0, normal.x + normal.z, normal.y ) ),\r\n\t\t\tnormal\r\n\t\t);\r\n\r\n\t\t#ifdef USE_NORMALMAP_Z\r\n\r\n\t\t\tvec3 mapN = t3( normalMap, normalMapY, normalMapZ ).xyz;\r\n\r\n\t\t#elif USE_NORMALMAP_Y\r\n\r\n\t\t\tvec3 mapN = t3( normalMap, normalMapY ).xyz;\r\n\r\n\t\t#else\r\n\r\n\t\t\tvec3 mapN = t3( normalMap ).xyz;\r\n\r\n\t\t#endif\r\n\r\n\t\t// Expand and scale the vector.\r\n\t\tmapN = mapN * 2.0 - 1.0;\r\n\t\tmapN.xy *= normalScale;\r\n\r\n\t\treturn normalize( tbn * mapN );\r\n\r\n\t}\r\n\r\n#endif\r\n",roughnessmap_triplanar_fragment:"float roughnessFactor = roughness;\r\n\r\n#ifdef USE_ROUGHNESSMAP\r\n\r\n\tvec4 texelRoughness = t3( roughnessMap );\r\n\troughnessFactor *= texelRoughness.r;\r\n\r\n#endif\r\n",specularmap_triplanar_fragment:"float specularStrength;\r\n\r\n#ifdef USE_SPECULARMAP\r\n\r\n\tvec4 texelSpecular = t3( specularMap );\r\n\tspecularStrength = texelSpecular.r;\r\n\r\n#else\r\n\r\n\tspecularStrength = 1.0;\r\n\r\n#endif",triplanar_pars_fragment:"#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )\r\n\r\n\tvarying vec3 vBlend;\r\n\tvarying vec2 vCoords[3];\r\n\r\n\tvec4 t3( sampler2D mapX, sampler2D mapY, sampler2D mapZ ) {\r\n\r\n\t\tvec4 xAxis = texture2D( mapX, vCoords[0] );\r\n\t\tvec4 yAxis = texture2D( mapY, vCoords[1] );\r\n\t\tvec4 zAxis = texture2D( mapZ, vCoords[2] );\r\n\r\n\t\treturn (\r\n\t\t\txAxis * vBlend.x +\r\n\t\t\tyAxis * vBlend.y +\r\n\t\t\tzAxis * vBlend.z\r\n\t\t);\r\n\r\n\t}\r\n\r\n\tvec4 t3( sampler2D mapX, sampler2D mapYZ ) {\r\n\r\n\t\treturn t3( mapX, mapYZ, mapYZ );\r\n\r\n\t}\r\n\r\n\tvec4 t3( sampler2D mapXYZ ) {\r\n\r\n\t\treturn t3( mapXYZ, mapXYZ, mapXYZ );\r\n\r\n\t}\r\n\r\n#endif\r\n",triplanar_pars_vertex:"#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )\r\n\r\n\tvarying vec3 vBlend;\r\n\tvarying vec2 vCoords[3];\r\n\r\n\tvec3 computeTriplanarBlend( vec3 normal ) {\r\n\r\n\t\t// Voxel-Based Terrain for Real-Time Virtual Simulations (Ch. 5).\r\n\t\tvec3 blend = saturate( abs( normal ) - 0.5 );\r\n\r\n\t\t// Raise each component of the normal vector to the 4th power.\r\n\t\tblend *= blend;\r\n\t\tblend *= blend;\r\n\r\n\t\t// Normalize the result by dividing by the sum of its components.\r\n\t\tblend /= dot( blend, vec3( 1.0 ) );\r\n\r\n\t\t// GPU Gems 3 (Ch. 1).\r\n\t\t//vec3 blend = abs( normal );\r\n\t\t//blend = ( blend - 0.2 ) * 7.0;  \r\n\t\t//blend = max( blend, 0.0 );\r\n\t\t//blend /= ( blend.x + blend.y + blend.z );\r\n\r\n\t\treturn blend;\r\n\r\n\t}\r\n\r\n#endif\r\n",triplanar_vertex:"#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )\r\n\r\n\tvCoords[0] = worldPosition.yz * offsetRepeat.zw + offsetRepeat.xy;\r\n\tvCoords[1] = worldPosition.zx * offsetRepeat.zw + offsetRepeat.xy;\r\n\tvCoords[2] = worldPosition.xy * offsetRepeat.zw + offsetRepeat.xy;\r\n\r\n\tvBlend = computeTriplanarBlend( normal );\r\n\r\n#endif\r\n"});var X=function(t){function n(){O(this,n);var t=N(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,{type:"MeshTriplanarPhysicalMaterial",defines:{PHYSICAL:""},uniforms:{mapY:new e.Uniform(null),mapZ:new e.Uniform(null),normalMapY:new e.Uniform(null),normalMapZ:new e.Uniform(null)},fragmentShader:H,vertexShader:Z,lights:!0,fog:!0})),i=e.ShaderLib.physical.uniforms,r=t.uniforms;return Object.keys(i).forEach(function(t){var n=i[t].value,s=new e.Uniform(n);Object.defineProperty(r,t,{value:null===n?s:s.clone()})}),t.envMap=null,t}return C(n,t),D(n,[{key:"setMaps",value:function(t,e,n){var i=this.defines,r=this.uniforms;void 0!==t&&(i.USE_MAP="",r.map.value=t),void 0!==e&&(i.USE_MAP_Y="",r.mapY.value=e),void 0!==n&&(i.USE_MAP_Z="",r.mapZ.value=n),this.needsUpdate=!0}},{key:"setNormalMaps",value:function(t,e,n){var i=this.defines,r=this.uniforms;void 0!==t&&(i.USE_NORMALMAP="",r.normalMap.value=t),void 0!==e&&(i.USE_NORMALMAP_Y="",r.normalMapY.value=e),void 0!==n&&(i.USE_NORMALMAP_Z="",r.normalMapZ.value=n),this.needsUpdate=!0}}]),n}(e.ShaderMaterial),W=(function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;O(this,t),this.x=e,this.y=n}D(t,[{key:"set",value:function(t,e){return this.x=t,this.y=e,this}},{key:"copy",value:function(t){return this.x=t.x,this.y=t.y,this}},{key:"fromArray",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return this.x=t[e],this.y=t[e+1],this}},{key:"toArray",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return t[e]=this.x,t[e+1]=this.y,t}},{key:"equals",value:function(t){return t.x===this.x&&t.y===this.y}},{key:"clone",value:function(){return new this.constructor(this.x,this.y)}},{key:"add",value:function(t){return this.x+=t.x,this.y+=t.y,this}},{key:"addScaledVector",value:function(t,e){return this.x+=t.x*e,this.y+=t.y*e,this}},{key:"addScalar",value:function(t){return this.x+=t,this.y+=t,this}},{key:"addVectors",value:function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this}},{key:"sub",value:function(t){return this.x-=t.x,this.y-=t.y,this}},{key:"subScalar",value:function(t){return this.x-=t,this.y-=t,this}},{key:"subVectors",value:function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this}},{key:"multiply",value:function(t){return this.x*=t.x,this.y*=t.y,this}},{key:"multiplyScalar",value:function(t){return isFinite(t)?(this.x*=t,this.y*=t):(this.x=0,this.y=0),this}},{key:"multiplyVectors",value:function(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this}},{key:"divide",value:function(t){return this.x/=t.x,this.y/=t.y,this}},{key:"divideScalar",value:function(t){return this.multiplyScalar(1/t)}},{key:"divideVectors",value:function(t,e){return this.x=t.x/e.x,this.y=t.y/e.y,this}},{key:"negate",value:function(){return this.x=-this.x,this.y=-this.y,this}},{key:"dot",value:function(t){return this.x*t.x+this.y*t.y}},{key:"lengthSq",value:function(){return this.x*this.x+this.y*this.y}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y)}},{key:"distanceTo",value:function(t){return Math.sqrt(this.distanceToSquared(t))}},{key:"distanceToSquared",value:function(t){var e=this.x-t.x,n=this.y-t.y;return e*e+n*n}},{key:"normalize",value:function(){return this.divideScalar(this.length())}},{key:"min",value:function(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this}},{key:"max",value:function(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this}},{key:"clamp",value:function(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this}}])}(),function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;O(this,t),this.x=e,this.y=n,this.z=i}return D(t,[{key:"set",value:function(t,e,n){return this.x=t,this.y=e,this.z=n,this}},{key:"copy",value:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}},{key:"fromArray",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this}},{key:"toArray",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t}},{key:"equals",value:function(t){return t.x===this.x&&t.y===this.y&&t.z===this.z}},{key:"clone",value:function(){return new this.constructor(this.x,this.y,this.z)}},{key:"add",value:function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}},{key:"addScaledVector",value:function(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this}},{key:"addScalar",value:function(t){return this.x+=t,this.y+=t,this.z+=t,this}},{key:"addVectors",value:function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this}},{key:"sub",value:function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}},{key:"subScalar",value:function(t){return this.x-=t,this.y-=t,this.z-=t,this}},{key:"subVectors",value:function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this}},{key:"multiply",value:function(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}},{key:"multiplyScalar",value:function(t){return isFinite(t)?(this.x*=t,this.y*=t,this.z*=t):(this.x=0,this.y=0,this.z=0),this}},{key:"multiplyVectors",value:function(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this}},{key:"divide",value:function(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}},{key:"divideScalar",value:function(t){return this.multiplyScalar(1/t)}},{key:"divideVectors",value:function(t,e){return this.x=t.x/e.x,this.y=t.y/e.y,this.z=t.z/e.z,this}},{key:"negate",value:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}},{key:"dot",value:function(t){return this.x*t.x+this.y*t.y+this.z*t.z}},{key:"lengthSq",value:function(){return this.x*this.x+this.y*this.y+this.z*this.z}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}},{key:"distanceTo",value:function(t){return Math.sqrt(this.distanceToSquared(t))}},{key:"distanceToSquared",value:function(t){var e=this.x-t.x,n=this.y-t.y,i=this.z-t.z;return e*e+n*n+i*i}},{key:"normalize",value:function(){return this.divideScalar(this.length())}},{key:"min",value:function(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this}},{key:"max",value:function(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this}},{key:"clamp",value:function(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this.z=Math.max(t.z,Math.min(e.z,this.z)),this}},{key:"applyMatrix3",value:function(t){var e=this.x,n=this.y,i=this.z,r=t.elements;return this.x=r[0]*e+r[3]*n+r[6]*i,this.y=r[1]*e+r[4]*n+r[7]*i,this.z=r[2]*e+r[5]*n+r[8]*i,this}},{key:"applyMatrix4",value:function(t){var e=this.x,n=this.y,i=this.z,r=t.elements;return this.x=r[0]*e+r[4]*n+r[8]*i+r[12],this.y=r[1]*e+r[5]*n+r[9]*i+r[13],this.z=r[2]*e+r[6]*n+r[10]*i+r[14],this}}]),t}()),G=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new W(1/0,1/0,1/0),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new W(-1/0,-1/0,-1/0);O(this,t),this.min=e,this.max=n}return D(t,[{key:"set",value:function(t,e){return this.min.copy(t),this.max.copy(e),this}},{key:"copy",value:function(t){return this.min.copy(t.min),this.max.copy(t.max),this}},{key:"clone",value:function(){return(new this.constructor).copy(this)}},{key:"expandByPoint",value:function(t){return this.min.min(t),this.max.max(t),this}},{key:"union",value:function(t){return this.min.min(t.min),this.max.max(t.max),this}},{key:"setFromPoints",value:function(t){var e=void 0,n=void 0;for(e=0,n=t.length;e<n;++e)this.expandByPoint(t[e]);return this}},{key:"setFromCenterAndSize",value:function(t,e){var n=e.clone().multiplyScalar(.5);return this.min.copy(t).sub(n),this.max.copy(t).add(n),this}},{key:"intersectsBox",value:function(t){return!(t.max.x<this.min.x||t.min.x>this.max.x||t.max.y<this.min.y||t.min.y>this.max.y||t.max.z<this.min.z||t.min.z>this.max.z)}}]),t}(),J=function(){function t(){O(this,t),this.elements=new Float32Array([1,0,0,0,1,0,0,0,1])}return D(t,[{key:"set",value:function(t,e,n,i,r,s,a,o,u){var l=this.elements;return l[0]=t,l[3]=e,l[6]=n,l[1]=i,l[4]=r,l[7]=s,l[2]=a,l[5]=o,l[8]=u,this}},{key:"identity",value:function(){return this.set(1,0,0,0,1,0,0,0,1),this}},{key:"copy",value:function(t){var e=t.elements;return this.set(e[0],e[3],e[6],e[1],e[4],e[7],e[2],e[5],e[8])}},{key:"clone",value:function(){return(new this.constructor).copy(this)}}]),t}(),Q=function(){function t(){O(this,t),this.elements=new Float32Array([1,0,0,1,0,1])}return D(t,[{key:"set",value:function(t,e,n,i,r,s){var a=this.elements;return a[0]=t,a[1]=e,a[3]=i,a[2]=n,a[4]=r,a[5]=s,this}},{key:"identity",value:function(){return this.set(1,0,0,1,0,1),this}},{key:"copy",value:function(t){var e=t.elements;return this.set(e[0],e[1],e[2],e[3],e[4],e[5]),this}},{key:"clone",value:function(){return(new this.constructor).copy(this)}},{key:"toMatrix3",value:function(t){var e=t.elements;t.set(e[0],e[1],e[2],e[1],e[3],e[4],e[2],e[4],e[5])}},{key:"add",value:function(t){var e=this.elements,n=t.elements;return e[0]+=n[0],e[1]+=n[1],e[3]+=n[3],e[2]+=n[2],e[4]+=n[4],e[5]+=n[5],this}},{key:"norm",value:function(){var t=this.elements,e=t[1]*t[1],n=t[2]*t[2],i=t[4]*t[4];return Math.sqrt(t[0]*t[0]+e+n+e+t[3]*t[3]+i+n+i+t[5]*t[5])}},{key:"off",value:function(){var t=this.elements;return Math.sqrt(2*(t[1]*t[1]+t[2]*t[2]+t[4]*t[4]))}},{key:"applyToVector3",value:function(t){var e=t.x,n=t.y,i=t.z,r=this.elements;return t.x=r[0]*e+r[1]*n+r[2]*i,t.y=r[1]*e+r[3]*n+r[4]*i,t.z=r[2]*e+r[4]*n+r[5]*i,t}}],[{key:"calculateIndex",value:function(t,e){return 3-(3-t)*(2-t)/2+e}}]),t}(),$=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new W,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new W;O(this,t),this.min=e,this.max=n,this.children=null}return D(t,[{key:"getCenter",value:function(){return this.min.clone().add(this.max).multiplyScalar(.5)}},{key:"getDimensions",value:function(){return this.max.clone().sub(this.min)}},{key:"split",value:function(t){var e=this.min,n=this.max,i=this.getCenter(),r=void 0,s=void 0,a=0,o=void 0,u=void 0,l=void 0,h=void 0,c=void 0;for(Array.isArray(t)&&(u=this.getDimensions().multiplyScalar(.5),l=[new W,new W,new W],a=t.length),this.children=[],r=0;r<8;++r){if(o=K[r],c=null,a>0)for(l[1].addVectors(e,l[0].fromArray(o).multiply(u)),l[2].addVectors(i,l[0].fromArray(o).multiply(u)),s=0;s<a;++s)if(null!==(h=t[s])&&l[1].equals(h.min)&&l[2].equals(h.max)){c=h,t[s]=null;break}this.children.push(null!==c?c:new this.constructor(new W(0===o[0]?e.x:i.x,0===o[1]?e.y:i.y,0===o[2]?e.z:i.z),new W(0===o[0]?i.x:n.x,0===o[1]?i.y:n.y,0===o[2]?i.z:n.z)))}}}]),t}(),K=[new Uint8Array([0,0,0]),new Uint8Array([0,0,1]),new Uint8Array([0,1,0]),new Uint8Array([0,1,1]),new Uint8Array([1,0,0]),new Uint8Array([1,0,1]),new Uint8Array([1,1,0]),new Uint8Array([1,1,1])],tt=[new Uint8Array([0,4]),new Uint8Array([1,5]),new Uint8Array([2,6]),new Uint8Array([3,7]),new Uint8Array([0,2]),new Uint8Array([1,3]),new Uint8Array([4,6]),new Uint8Array([5,7]),new Uint8Array([0,1]),new Uint8Array([2,3]),new Uint8Array([4,5]),new Uint8Array([6,7])],et=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new W,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;O(this,t),this.min=e,this.size=n,this.children=null}return D(t,[{key:"getCenter",value:function(){return this.min.clone().addScalar(.5*this.size)}},{key:"getDimensions",value:function(){return new W(this.size,this.size,this.size)}},{key:"split",value:function(t){var e=this.min,n=this.getCenter(),i=.5*this.size,r=void 0,s=void 0,a=0,o=void 0,u=void 0,l=void 0,h=void 0;for(Array.isArray(t)&&(u=new W,a=t.length),this.children=[],r=0;r<8;++r){if(o=K[r],h=null,a>0)for(u.fromArray(o).multiplyScalar(i).add(e),s=0;s<a;++s)if(null!==(l=t[s])&&l.size===i&&u.equals(l.min)){h=l,t[s]=null;break}this.children.push(null!==h?h:new this.constructor(new W(0===o[0]?e.x:n.x,0===o[1]?e.y:n.y,0===o[2]?e.z:n.z),i))}}},{key:"max",get:function(){return this.min.clone().addScalar(this.size)}}]),t}(),nt=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];O(this,t),this.value=e,this.done=n}return D(t,[{key:"reset",value:function(){this.value=null,this.done=!1}}]),t}(),it=new G,rt=function(){function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;O(this,t),this.octree=e,this.region=n,this.cull=null!==n,this.result=new nt,this.trace=null,this.indices=null,this.reset()}return D(t,[{key:"reset",value:function(){var t=this.octree.root;return this.trace=[],this.indices=[],null!==t&&(it.min=t.min,it.max=t.max,this.cull&&!this.region.intersectsBox(it)||(this.trace.push(t),this.indices.push(0))),this.result.reset(),this}},{key:"next",value:function(){for(var t=this.cull,e=this.region,n=this.indices,i=this.trace,r=null,s=i.length-1,a=void 0,o=void 0,u=void 0;null===r&&s>=0;)if(a=n[s],o=i[s].children,++n[s],a<8)if(null!==o){if(u=o[a],t&&(it.min=u.min,it.max=u.max,!e.intersectsBox(it)))continue;i.push(u),n.push(0),++s}else r=i.pop(),n.pop();else i.pop(),n.pop(),--s;return this.result.value=r,this.result.done=null===r,this.result}},{key:"return",value:function(t){return this.result.value=t,this.result.done=!0,this.result}},{key:Symbol.iterator,value:function(){return this}}]),t}(),st=new Uint8Array([0,1,2,3,4,5,6,7,0]),at=[new Uint8Array([4,2,1]),new Uint8Array([5,3,8]),new Uint8Array([6,8,3]),new Uint8Array([7,8,8]),new Uint8Array([8,6,5]),new Uint8Array([8,7,8]),new Uint8Array([8,8,7]),new Uint8Array([8,8,8])],ot=function(){function t(){O(this,t)}return D(t,null,[{key:"intersectOctree",value:function(t,e,n){var i=t.getDimensions(),s=i.clone().multiplyScalar(.5),a=t.min.clone().sub(t.min),o=t.max.clone().sub(t.min),u=e.ray.direction.clone(),l=e.ray.origin.clone();l.sub(t.getCenter()).add(s);var h=void 0,c=void 0,d=void 0,v=void 0,f=void 0,y=void 0,m=void 0,p=void 0,g=void 0;st[8]=st[0],u.x<0&&(l.x=i.x-l.x,u.x=-u.x,st[8]|=st[4]),u.y<0&&(l.y=i.y-l.y,u.y=-u.y,st[8]|=st[2]),u.z<0&&(l.z=i.z-l.z,u.z=-u.z,st[8]|=st[1]),h=1/u.x,c=1/u.y,d=1/u.z,v=(a.x-l.x)*h,f=(o.x-l.x)*h,y=(a.y-l.y)*c,m=(o.y-l.y)*c,p=(a.z-l.z)*d,g=(o.z-l.z)*d,Math.max(Math.max(v,y),p)<Math.min(Math.min(f,m),g)&&r(t.root,v,y,p,f,m,g,e,n)}}]),t}(),ut=new G,lt=function(){function t(e,n){O(this,t),this.root=void 0!==e&&void 0!==n?new $(e,n):null}return D(t,[{key:"getCenter",value:function(){return this.root.getCenter()}},{key:"getDimensions",value:function(){return this.root.getDimensions()}},{key:"getDepth",value:function(){return s(this.root)}},{key:"cull",value:function(t){var e=[];return a(this.root,t,e),e}},{key:"findOctantsByLevel",value:function(t){var e=[];return o(this.root,t,0,e),e}},{key:"raycast",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return ot.intersectOctree(this,t,e),e}},{key:"leaves",value:function(t){return new rt(this,t)}},{key:Symbol.iterator,value:function(){return new rt(this)}},{key:"min",get:function(){return this.root.min}},{key:"max",get:function(){return this.root.max}},{key:"children",get:function(){return this.root.children}}]),t}(),ht=function(t){function e(t,n){O(this,e);var i=N(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n));return i.points=null,i.data=null,i}return C(e,$),D(e,[{key:"distanceToSquared",value:function(t){return t.clone().clamp(this.min,this.max).sub(t).lengthSq()}},{key:"distanceToCenterSquared",value:function(t){var e=this.getCenter(),n=t.x-e.x,i=t.y-e.x,r=t.z-e.z;return n*n+i*i+r*r}},{key:"contains",value:function(t,e){var n=this.min,i=this.max;return t.x>=n.x-e&&t.y>=n.y-e&&t.z>=n.z-e&&t.x<=i.x+e&&t.y<=i.y+e&&t.z<=i.z+e}},{key:"redistribute",value:function(t){var e=this.children,n=this.points,i=this.data,r=void 0,s=void 0,a=void 0,o=void 0,u=void 0;if(null!==e)for(;n.length>0;)for(o=n.pop(),u=i.pop(),r=0,s=e.length;r<s;++r)if((a=e[r]).contains(o,t)){null===a.points&&(a.points=[],a.data=[]),a.points.push(o),a.data.push(u);break}this.points=null,this.data=null}},{key:"merge",value:function(){var t=this.children,e=void 0,n=void 0,i=void 0;if(null!==t){for(this.points=[],this.data=[],e=0,n=t.length;e<n;++e)if(null!==(i=t[e]).points){var r,s;(r=this.points).push.apply(r,T(i.points)),(s=this.data).push.apply(s,T(i.data))}this.children=null}}}]),e}(),ct=(function(t){function e(t,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:8,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:8;O(this,e);var a=N(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return a.root=new ht(t,n),a.bias=Math.max(0,i),a.biasSquared=a.bias*a.bias,a.maxPoints=Math.max(1,Math.round(r)),a.maxDepth=Math.max(0,Math.round(s)),a}C(e,lt),D(e,[{key:"countPoints",value:function(){return u(this.root)}},{key:"add",value:function(t,e){l(this.root,t,e,0,this.bias,this.maxPoints,this.maxDepth)}},{key:"remove",value:function(t){h(this.root,null,t,this.bias,this.maxPoints)}},{key:"fetch",value:function(t){return c(this.root,t,this.bias,this.biasSquared)}},{key:"findNearestPoint",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1/0,n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return d(this.root,t,e,n)}},{key:"findPoints",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=[];return v(this.root,t,e,n,i),i}},{key:"raycast",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],i=I(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"raycast",this).call(this,t);return i.length>0&&this.testPoints(i,t,n),n}},{key:"testPoints",value:function(t,e,n){var i=e.params.Points.threshold,r=i*i,s=void 0,a=void 0,o=void 0,u=void 0,l=void 0,h=void 0,c=void 0,d=void 0,v=void 0,f=void 0,y=void 0;for(l=0,c=t.length;l<c;++l)if(v=t[l],null!==(f=v.points))for(h=0,d=f.length;h<d;++h)y=f[h],(u=e.ray.distanceSqToPoint(y))<r&&(s=e.ray.closestPointToPoint(y),(a=e.ray.origin.distanceTo(s))>=e.near&&a<=e.far&&(o=Math.sqrt(u),n.push({distance:a,distanceToRay:o,point:s.clone(),object:v.data[h]})))}}])}(),{AIR:0,SOLID:1}),dt=function(){function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e;O(this,t),this.edges=[new Uint32Array(e),new Uint32Array(n),new Uint32Array(i)],this.zeroCrossings=[new Float32Array(e),new Float32Array(n),new Float32Array(i)],this.normals=[new Float32Array(3*e),new Float32Array(3*n),new Float32Array(3*i)]}return D(t,[{key:"createTransferList",value:function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=[this.edges[0],this.edges[1],this.edges[2],this.zeroCrossings[0],this.zeroCrossings[1],this.zeroCrossings[2],this.normals[0],this.normals[1],this.normals[2]],n=void 0;e.length>0;)null!==(n=e.pop())&&t.push(n.buffer);return t}},{key:"serialise",value:function(){return{edges:this.edges,zeroCrossings:this.zeroCrossings,normals:this.normals}}},{key:"deserialise",value:function(t){this.edges=t.edges,this.zeroCrossings=t.zeroCrossings,this.normals=t.normals}}],[{key:"calculate1DEdgeCount",value:function(t){return Math.pow(t+1,2)*t}}]),t}(),vt=0,ft=0,yt=function(){function t(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];O(this,t),this.lod=-1,this.neutered=!1,this.materials=0,this.materialIndices=e?new Uint8Array(ft):null,this.runLengths=null,this.edgeData=null}return D(t,[{key:"set",value:function(t){return this.lod=t.lod,this.neutered=t.neutered,this.materials=t.materials,this.materialIndices=t.materialIndices,this.runLengths=t.runLengths,this.edgeData=t.edgeData,this}},{key:"setMaterialIndex",value:function(t,e){this.materialIndices[t]===ct.AIR?e!==ct.AIR&&++this.materials:e===ct.AIR&&--this.materials,this.materialIndices[t]=e}},{key:"compress",value:function(){var t=void 0;return null===this.runLengths&&(t=this.full?{runLengths:[this.materialIndices.length],data:[ct.SOLID]}:B.encode(this.materialIndices),this.runLengths=new Uint32Array(t.runLengths),this.materialIndices=new Uint8Array(t.data)),this}},{key:"decompress",value:function(){return null!==this.runLengths&&(this.materialIndices=B.decode(this.runLengths,this.materialIndices,new Uint8Array(ft)),this.runLengths=null),this}},{key:"createTransferList",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return null!==this.edgeData&&this.edgeData.createTransferList(t),t.push(this.materialIndices.buffer),t.push(this.runLengths.buffer),t}},{key:"serialise",value:function(){return this.neutered=!0,{lod:this.lod,materials:this.materials,materialIndices:this.materialIndices,runLengths:this.runLengths,edgeData:null!==this.edgeData?this.edgeData.serialise():null}}},{key:"deserialise",value:function(t){this.lod=t.lod,this.materials=t.materials,this.materialIndices=t.materialIndices,this.runLengths=t.runLengths,null!==t.edgeData?(null===this.edgeData&&(this.edgeData=new dt(0)),this.edgeData.deserialise(t.edgeData)):this.edgeData=null,this.neutered=!1}},{key:"empty",get:function(){return 0===this.materials}},{key:"full",get:function(){return this.materials===ft}}],[{key:"resolution",get:function(){return vt},set:function(t){0===vt&&(vt=Math.max(1,Math.min(256,t)),ft=Math.pow(vt+1,3))}}]),t}(),mt=function(t){function e(t,n){O(this,e);var i=N(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n));return i.data=null,i.csg=null,i}return C(e,et),D(e,[{key:"createTransferList",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return null!==this.data?this.data.createTransferList(t):t}},{key:"serialise",value:function(){return{resolution:this.resolution,min:this.min.toArray(),size:this.size,data:null!==this.data?this.data.serialise():null}}},{key:"deserialise",value:function(t){this.resolution=t.resolution,this.min.fromArray(t.min),this.size=t.size,null!==t.data?(null===this.data&&(this.data=new yt(!1)),this.data.deserialise(t.data)):this.data=null}},{key:"resolution",get:function(){return yt.resolution},set:function(t){yt.resolution=t}}]),e}(),pt=new G,gt=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:32,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:32;O(this,e);var i=N(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return i.root=new mt,i.chunkSize=Math.max(1,f(t)),i.min.subScalar(2*i.chunkSize),i.size=4*i.chunkSize,i.root.resolution=f(n),i}return C(e,lt),D(e,[{key:"grow",value:function(t,e,n,i){var r=t.children,s=void 0,a=void 0;if(pt.min=t.min,pt.max=t.max,e.intersectsBox(pt))if(null===r&&t.size>n&&(t.split(),r=t.children),null!==r)for(s=0,a=r.length;s<a;++s)this.grow(r[s],e,n,i);else i.push(t)}},{key:"edit",value:function(t){var e=t.completeBoundingBox,n=[];return t.operation===U.UNION?(this.expand(e),this.grow(this.root,e,this.chunkSize,n)):n=t.operation===U.DIFFERENCE?this.leaves(e):this.leaves(),n}},{key:"expand",value:function(t){var e=t.min,n=t.max,i=Math.max(Math.max(Math.max(Math.abs(e.x),Math.abs(e.y)),Math.abs(e.z)),Math.max(Math.max(Math.abs(n.x),Math.abs(n.y)),Math.abs(n.z))),r=this.size/2,s=this.children,a=void 0,o=void 0;if(i>r)if(a=f(Math.ceil(i/this.chunkSize)*this.chunkSize),null===s)this.min.set(-a,-a,-a),this.size=2*a;else for(;r<a;){for(r=this.size,this.min.multiplyScalar(2),this.size*=2,this.root.split(),o=0;o<8;++o)null!==s[o].children&&this.children[o].split([s[o]]);s=this.children}}},{key:"prune",value:function(t){}},{key:"load",value:function(t){mt.resolution=t.resolution,this.chunkSize=t.chunkSize,this.root=t.root}},{key:"toJSON",value:function(){return{resolution:mt.resolution,chunkSize:this.chunkSize,root:this.root}}},{key:"size",get:function(){return this.root.size},set:function(t){this.root.size=t}},{key:"resolution",get:function(){return this.root.resolution}}]),e}(),xt={SPHERE:"sdf.sphere",BOX:"sdf.box",TORUS:"sdf.torus",PLANE:"sdf.plane",HEIGHTFIELD:"sdf.heightfield"},kt=function(){function t(e){O(this,t),this.type=e;for(var n=arguments.length,i=Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];this.children=i,this.bbox=null}return D(t,[{key:"computeBoundingBox",value:function(){var t=this.children,e=void 0,n=void 0;for(this.bbox=new G,e=0,n=t.length;e<n;++e)this.bbox.union(t[e].boundingBox);return this.bbox}},{key:"boundingBox",get:function(){return null!==this.bbox?this.bbox:this.computeBoundingBox()}}]),t}(),bt=function(t){function e(){var t;O(this,e);for(var n=arguments.length,i=Array(n),r=0;r<n;r++)i[r]=arguments[r];return N(this,(t=e.__proto__||Object.getPrototypeOf(e)).call.apply(t,[this,U.UNION].concat(i)))}return C(e,kt),D(e,[{key:"updateMaterialIndex",value:function(t,e,n){var i=n.materialIndices[t];i!==ct.AIR&&e.setMaterialIndex(t,i)}},{key:"selectEdge",value:function(t,e,n){return n?t.t>e.t?t:e:t.t<e.t?t:e}}]),e}(),wt=function(t){function e(){var t;O(this,e);for(var n=arguments.length,i=Array(n),r=0;r<n;r++)i[r]=arguments[r];return N(this,(t=e.__proto__||Object.getPrototypeOf(e)).call.apply(t,[this,U.DIFFERENCE].concat(i)))}return C(e,kt),D(e,[{key:"updateMaterialIndex",value:function(t,e,n){n.materialIndices[t]!==ct.AIR&&e.setMaterialIndex(t,ct.AIR)}},{key:"selectEdge",value:function(t,e,n){return n?t.t<e.t?t:e:t.t>e.t?t:e}}]),e}(),_t=function(t){function e(){var t;O(this,e);for(var n=arguments.length,i=Array(n),r=0;r<n;r++)i[r]=arguments[r];return N(this,(t=e.__proto__||Object.getPrototypeOf(e)).call.apply(t,[this,U.INTERSECTION].concat(i)))}return C(e,kt),D(e,[{key:"updateMaterialIndex",value:function(t,e,n){var i=n.materialIndices[t];e.setMaterialIndex(t,e.materialIndices[t]!==ct.AIR&&i!==ct.AIR?i:ct.AIR)}},{key:"selectEdge",value:function(t,e,n){return n?t.t<e.t?t:e:t.t>e.t?t:e}}]),e}(),zt=function(t){function e(t){O(this,e);var n=N(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,U.DENSITY_FUNCTION));return n.sdf=t,n}return C(e,kt),D(e,[{key:"computeBoundingBox",value:function(){return this.bbox=this.sdf.computeBoundingBox(),this.bbox}},{key:"generateMaterialIndex",value:function(t){return this.sdf.sample(t)<=0?this.sdf.material:ct.AIR}},{key:"generateEdge",value:function(t){t.approximateZeroCrossing(this.sdf),t.computeSurfaceNormal(this.sdf)}}]),e}(),At=function(){function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ct.SOLID;O(this,t),this.type=e,this.operation=null,this.material=Math.min(255,Math.max(ct.SOLID,Math.trunc(n))),this.children=[],this.bbox=null}return D(t,[{key:"union",value:function(t){return t.operation=U.UNION,this.children.push(t),this}},{key:"subtract",value:function(t){return t.operation=U.DIFFERENCE,this.children.push(t),this}},{key:"intersect",value:function(t){return t.operation=U.INTERSECTION,this.children.push(t),this}},{key:"serialise",value:function(){var t={type:this.type,operation:this.operation,material:this.material,parameters:null,children:[]},e=this.children,n=void 0,i=void 0;for(n=0,i=e.length;n<i;++n)t.children.push(e[n].serialise());return t}},{key:"toCSG",value:function(){var t=this.children,e=new zt(this),n=void 0,i=void 0,r=void 0,s=void 0;for(r=0,s=t.length;r<s;++r){if(i=t[r],n!==i.operation)switch(n=i.operation){case U.UNION:e=new bt(e);break;case U.DIFFERENCE:e=new wt(e);break;case U.INTERSECTION:e=new _t(e)}e.children.push(i.toCSG())}return e}},{key:"computeBoundingBox",value:function(){throw new Error("SDF: bounding box method not implemented!")}},{key:"sample",value:function(t){throw new Error("SDF: sample method not implemented!")}},{key:"boundingBox",get:function(){return null!==this.bbox?this.bbox:this.computeBoundingBox()}},{key:"completeBoundingBox",get:function(){var t=this.children,e=this.boundingBox.clone(),n=void 0,i=void 0;for(n=0,i=t.length;n<i;++n)e.union(t[n].completeBoundingBox);return e}}]),t}(),Mt=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments[1];O(this,e);var i=N(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,xt.SPHERE,n));return i.origin=new(Function.prototype.bind.apply(W,[null].concat(T(t.origin)))),i.radius=t.radius,i}return C(e,At),D(e,[{key:"computeBoundingBox",value:function(){return this.bbox=new G,this.bbox.min.copy(this.origin).subScalar(this.radius),this.bbox.max.copy(this.origin).addScalar(this.radius),this.bbox}},{key:"sample",value:function(t){var e=this.origin,n=t.x-e.x,i=t.y-e.y,r=t.z-e.z;return Math.sqrt(n*n+i*i+r*r)-this.radius}},{key:"serialise",value:function(){var t=I(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"serialise",this).call(this);return t.parameters={origin:this.origin.toArray(),radius:this.radius},t}}]),e}(),St=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments[1];O(this,e);var i=N(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,xt.BOX,n));return i.origin=new(Function.prototype.bind.apply(W,[null].concat(T(t.origin)))),i.halfDimensions=new(Function.prototype.bind.apply(W,[null].concat(T(t.halfDimensions)))),i}return C(e,At),D(e,[{key:"computeBoundingBox",value:function(){return this.bbox=new G,this.bbox.min.subVectors(this.origin,this.halfDimensions),this.bbox.max.addVectors(this.origin,this.halfDimensions),this.bbox}},{key:"sample",value:function(t){var e=this.origin,n=this.halfDimensions,i=Math.abs(t.x-e.x)-n.x,r=Math.abs(t.y-e.y)-n.y,s=Math.abs(t.z-e.z)-n.z,a=Math.max(i,Math.max(r,s)),o=Math.max(i,0),u=Math.max(r,0),l=Math.max(s,0),h=Math.sqrt(o*o+u*u+l*l);return Math.min(a,0)+h}},{key:"serialise",value:function(){var t=I(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"serialise",this).call(this);return t.parameters={origin:this.origin.toArray(),halfDimensions:this.halfDimensions.toArray()},t}}]),e}(),Et=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments[1];O(this,e);var i=N(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,xt.PLANE,n));return i.normal=new(Function.prototype.bind.apply(W,[null].concat(T(t.normal)))),i.constant=t.constant,i}return C(e,At),D(e,[{key:"computeBoundingBox",value:function(){return this.bbox=new G,this.bbox}},{key:"sample",value:function(t){return this.normal.dot(t)+this.constant}},{key:"serialise",value:function(){var t=I(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"serialise",this).call(this);return t.parameters={normal:this.normal.toArray(),constant:this.constant},t}}]),e}(),Pt=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments[1];O(this,e);var i=N(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,xt.TORUS,n));return i.origin=new(Function.prototype.bind.apply(W,[null].concat(T(t.origin)))),i.R=t.R,i.r=t.r,i}return C(e,At),D(e,[{key:"computeBoundingBox",value:function(){return this.bbox=new G,this.bbox.min.copy(this.origin).subScalar(this.R).subScalar(this.r),this.bbox.max.copy(this.origin).addScalar(this.R).addScalar(this.r),this.bbox}},{key:"sample",value:function(t){var e=this.origin,n=t.x-e.x,i=t.y-e.y,r=t.z-e.z,s=Math.sqrt(n*n+r*r)-this.R;return Math.sqrt(s*s+i*i)-this.r}},{key:"serialise",value:function(){var t=I(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"serialise",this).call(this);return t.parameters={origin:this.origin.toArray(),R:this.R,r:this.r},t}}]),e}(),Ut=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments[1];O(this,e);var i=N(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,xt.HEIGHTFIELD,n));return i.min=new(Function.prototype.bind.apply(W,[null].concat(T(t.min)))),i.dimensions=new(Function.prototype.bind.apply(W,[null].concat(T(t.size)))),i.data=t.data,i}return C(e,At),D(e,[{key:"computeBoundingBox",value:function(){return this.bbox=new G,this.bbox.min.copy(this.min),this.bbox.max.addVectors(this.min,this.dimensions),this.bbox}},{key:"sample",value:function(t){var e=this.min,n=this.dimensions,i=Math.max(e.x,Math.min(e.x+n.x,t.x-e.x)),r=Math.max(e.z,Math.min(e.z+n.z,t.z-e.z));return t.y-e.y-this.data[r*n.x+i]/255*n.y}},{key:"serialise",value:function(){var t=I(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"serialise",this).call(this);return t.parameters={min:this.min.toArray(),dimensions:this.dimensions.toArray(),data:this.data},t}}]),e}(),Ot=function(){function t(){O(this,t)}return D(t,null,[{key:"reviveSDF",value:function(t){var e=void 0,n=void 0,i=void 0;switch(t.type){case xt.SPHERE:e=new Mt(t.parameters,t.material);break;case xt.BOX:e=new St(t.parameters,t.material);break;case xt.TORUS:e=new Pt(t.parameters,t.material);break;case xt.PLANE:e=new Et(t.parameters,t.material);break;case xt.HEIGHTFIELD:e=new Ut(t.parameters,t.material)}for(e.operation=t.operation,n=0,i=t.children.length;n<i;++n)e.children.push(this.reviveSDF(t.children[n]));return e}}]),t}(),Dt={EXTRACT:"worker.extract",MODIFY:"worker.modify",CLOSE:"worker.close"},It=function(t){function e(t){O(this,e);var n=N(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n.worker=null,n.data=null,n}return C(e,q),e}(),Ct=new It("message"),Nt='!function(){"use strict";function t(t,n,e,i,r,s){var o=0;return t>n&&t>e?(r<t&&(o|=2),s<t&&(o|=1)):n>e?(i<n&&(o|=4),s<n&&(o|=1)):(i<e&&(o|=4),r<e&&(o|=2)),o}function n(t,n,e,i){var r=void 0,s=0;return n<e?(r=n,s=0):(r=e,s=1),i<r&&(s=2),K[t][s]}function e(i,r,s,o,a,u,l,h,c){var d=i.children,y=void 0,v=void 0,f=void 0,m=void 0;if(a>=0&&u>=0&&l>=0)if(null===d)c.push(i);else{y=t(r,s,o,v=.5*(r+a),f=.5*(s+u),m=.5*(o+l));do{switch(y){case 0:e(d[J[8]],r,s,o,v,f,m,h,c),y=n(y,v,f,m);break;case 1:e(d[J[8]^J[1]],r,s,m,v,f,l,h,c),y=n(y,v,f,l);break;case 2:e(d[J[8]^J[2]],r,f,o,v,u,m,h,c),y=n(y,v,u,m);break;case 3:e(d[J[8]^J[3]],r,f,m,v,u,l,h,c),y=n(y,v,u,l);break;case 4:e(d[J[8]^J[4]],v,s,o,a,f,m,h,c),y=n(y,a,f,m);break;case 5:e(d[J[8]^J[5]],v,s,m,a,f,l,h,c),y=n(y,a,f,l);break;case 6:e(d[J[8]^J[6]],v,f,o,a,u,m,h,c),y=n(y,a,u,m);break;case 7:e(d[J[8]^J[7]],v,f,m,a,u,l,h,c),y=8}}while(y<8)}}function i(t){var n=t.children,e=0,r=void 0,s=void 0,o=void 0;if(null!==n)for(r=0,s=n.length;r<s;++r)(o=1+i(n[r]))>e&&(e=o);return e}function r(t,n,e){var i=t.children,s=void 0,o=void 0;if(W.min=t.min,W.max=t.max,n.intersectsBox(W))if(null!==i)for(s=0,o=i.length;s<o;++s)r(i[s],n,e);else e.push(t)}function s(t,n,e,i){var r=t.children,o=void 0,a=void 0;if(e===n)i.push(t);else if(null!==r)for(++e,o=0,a=r.length;o<a;++o)s(r[o],n,e,i)}function o(t){var n=t.children,e=0,i=void 0,r=void 0;if(null!==n)for(i=0,r=n.length;i<r;++i)e+=o(n[i]);else null!==t.points&&(e=t.points.length);return e}function a(t,n,e,i,r,s,o){var u=t.children,l=!1,h=!1,c=void 0,d=void 0;if(t.contains(n,r)){if(null===u){if(null===t.points)t.points=[],t.data=[];else for(c=0,d=t.points.length;!l&&c<d;++c)l=t.points[c].equals(n);l?(t.data[c-1]=e,h=!0):t.points.length<s||i===o?(t.points.push(n.clone()),t.data.push(e),h=!0):(t.split(),t.redistribute(r),u=t.children)}if(null!==u)for(++i,c=0,d=u.length;!h&&c<d;++c)h=a(u[c],n,e,i,r,s,o)}return h}function u(t,n,e,i,r){var s=t.children,a=!1,l=void 0,h=void 0,c=void 0,d=void 0,y=void 0;if(t.contains(e,i))if(null!==s)for(l=0,h=s.length;!a&&l<h;++l)a=u(s[l],t,e,i,r);else if(null!==t.points)for(c=t.points,d=t.data,l=0,h=c.length;!a&&l<h;++l)c[l].equals(e)&&(l<(y=h-1)&&(c[l]=c[y],d[l]=d[y]),c.pop(),d.pop(),null!==n&&o(n)<=r&&n.merge(),a=!0);return a}function l(t,n,e,i){var r=t.children,s=null,o=void 0,a=void 0,u=void 0;if(t.contains(n,e))if(null!==r)for(o=0,a=r.length;null===s&&o<a;++o)s=l(r[o],n,e,i);else for(o=0,a=(u=t.points).length;null===s&&o<a;++o)n.distanceToSquared(u[o])<=i&&(s=t.data[o]);return s}function h(t,n,e,i){var r=t.points,s=t.children,o=null,a=e,u=void 0,l=void 0,c=void 0,d=void 0,y=void 0,v=void 0,f=void 0;if(null!==s)for(u=0,l=(y=s.map(function(t){return{octant:t,distance:t.distanceToCenterSquared(n)}}).sort(function(t,n){return t.distance-n.distance})).length;u<l;++u)(v=y[u].octant).contains(n,a)&&null!==(f=h(v,n,a,i))&&(d=f.point.distanceToSquared(n),(!i||d>0)&&d<a&&(a=d,o=f));else if(null!==r)for(u=0,l=r.length;u<l;++u)c=r[u],d=n.distanceToSquared(c),(!i||d>0)&&d<a&&(a=d,o={point:c.clone(),data:t.data[u]});return o}function c(t,n,e,i,r){var s=t.points,o=t.children,a=e*e,u=void 0,l=void 0,h=void 0,d=void 0,y=void 0;if(null!==o)for(u=0,l=o.length;u<l;++u)(y=o[u]).contains(n,e)&&c(y,n,e,i,r);else if(null!==s)for(u=0,l=s.length;u<l;++u)h=s[u],d=n.distanceToSquared(h),(!i||d>0)&&d<=a&&r.push({point:h.clone(),data:t.data[u]})}function d(t,n,e){var i=void 0,r=void 0,s=void 0;0===n?(rt.c=1,rt.s=0):(i=(e-t)/(2*n),r=Math.sqrt(1+i*i),s=1/(i>=0?i+r:i-r),rt.c=1/Math.sqrt(1+s*s),rt.s=s*rt.c)}function y(t,n){0!==t.elements[1]&&it.rot01Post(n,st.rot01(t))}function v(t,n){0!==t.elements[2]&&it.rot02Post(n,st.rot02(t))}function f(t,n){0!==t.elements[4]&&it.rot12Post(n,st.rot12(t))}function m(t,n,e,i,r){var s=i*n.copy(t).norm(),o=void 0;for(o=0;o<r&&n.off()>s;++o)y(n,e),v(n,e),f(n,e)}function p(t,n){var e=1/t;return Math.abs(t)<n||Math.abs(e)<n?0:e}function x(t,n,e,i){var r=t.elements,s=n.elements,o=e.elements,a=s[0],u=s[3],l=s[5],h=p(a,i),c=p(u,i),d=p(l,i),y=3-((0===h)+(0===c)+(0===d)),v=o[0],f=o[3],m=o[6],x=o[1],g=o[4],k=o[7],w=o[2],b=o[5],z=o[8];return r[0]=v*h*v+f*c*f+m*d*m,r[3]=v*h*x+f*c*g+m*d*k,r[6]=v*h*w+f*c*b+m*d*z,r[1]=r[3],r[4]=x*h*x+g*c*g+k*d*k,r[7]=x*h*w+g*c*b+k*d*z,r[2]=r[6],r[5]=r[7],r[8]=w*h*w+b*c*b+z*d*z,y}function g(t,n,e,i,r){var s=t+1,o=s*s,a=new dt,u=void 0,l=void 0,h=void 0,c=void 0,d=void 0;for(u=0,d=0;d<8;++d)c=(i+(h=j[d])[2])*o+(e+h[1])*s+(n+h[0]),u|=Math.min(r[c],nt.SOLID)<<d;for(l=0,d=0;d<12;++d)(u>>H[d][0]&1)!==(u>>H[d][1]&1)&&++l;return a.materials=u,a.edgeCount=l,a.qefData=new et,a}function k(t,n,e){var i=[-1,-1,-1,-1],r=[!1,!1,!1,!1],s=1/0,o=0,a=!1,u=void 0,l=void 0,h=void 0,c=void 0,d=void 0,y=void 0,v=void 0;for(v=0;v<4;++v)d=t[v],y=wt[n][v],u=H[y][0],l=H[y][1],h=d.voxel.materials>>u&1,c=d.voxel.materials>>l&1,d.size<s&&(s=d.size,o=v,a=h!==nt.AIR),i[v]=d.voxel.index,r[v]=h!==c;r[o]&&(a?(e.push(i[0]),e.push(i[3]),e.push(i[1]),e.push(i[0]),e.push(i[2]),e.push(i[3])):(e.push(i[0]),e.push(i[1]),e.push(i[3]),e.push(i[0]),e.push(i[3]),e.push(i[2])))}function w(t,n,e){var i=[0,0,0,0],r=void 0,s=void 0,o=void 0,a=void 0;if(null!==t[0].voxel&&null!==t[1].voxel&&null!==t[2].voxel&&null!==t[3].voxel)k(t,n,e);else for(o=0;o<2;++o){for(i[0]=kt[n][o][0],i[1]=kt[n][o][1],i[2]=kt[n][o][2],i[3]=kt[n][o][3],r=[],a=0;a<4;++a)if(null!==(s=t[a]).voxel)r[a]=s;else{if(null===s.children)break;r[a]=s.children[i[a]]}4===a&&w(r,kt[n][o][4],e)}}function b(t,n,e){var i=[0,0,0,0],r=[[0,0,1,1],[0,1,0,1]],s=void 0,o=void 0,a=void 0,u=void 0,l=void 0;if(null!==t[0].children||null!==t[1].children){for(u=0;u<4;++u)i[0]=xt[n][u][0],i[1]=xt[n][u][1],b([null===t[0].children?t[0]:t[0].children[i[0]],null===t[1].children?t[1]:t[1].children[i[1]]],xt[n][u][2],e);for(u=0;u<4;++u){for(i[0]=gt[n][u][1],i[1]=gt[n][u][2],i[2]=gt[n][u][3],i[3]=gt[n][u][4],o=r[gt[n][u][0]],s=[],l=0;l<4;++l)if(null!==(a=t[o[l]]).voxel)s[l]=a;else{if(null===a.children)break;s[l]=a.children[i[l]]}4===l&&w(s,gt[n][u][5],e)}}}function z(t,n){var e=t.children,i=[0,0,0,0],r=void 0;if(null!==e){for(r=0;r<8;++r)z(e[r],n);for(r=0;r<12;++r)i[0]=mt[r][0],i[1]=mt[r][1],b([e[i[0]],e[i[1]]],mt[r][2],n);for(r=0;r<6;++r)i[0]=pt[r][0],i[1]=pt[r][1],i[2]=pt[r][2],i[3]=pt[r][3],w([e[i[0]],e[i[1]],e[i[2]],e[i[3]]],pt[r][4],n)}}function A(t,n,e,i){var r=void 0,s=void 0;if(null!==t.children)for(r=0;r<8;++r)i=A(t.children[r],n,e,i);else null!==t.voxel&&((s=t.voxel).index=i,n[3*i]=s.position.x,n[3*i+1]=s.position.y,n[3*i+2]=s.position.z,e[3*i]=s.normal.x,e[3*i+1]=s.normal.y,e[3*i+2]=s.normal.z,++i);return i}function U(t,n){var e=t.size,i=t.resolution,r=new R(0,0,0),s=new R(i,i,i),o=new L(t.min,t.max);return n.type!==Dt.INTERSECTION&&(n.boundingBox.intersectsBox(o)?(r.copy(n.boundingBox.min).max(o.min).sub(o.min),r.x=Math.ceil(r.x*i/e),r.y=Math.ceil(r.y*i/e),r.z=Math.ceil(r.z*i/e),s.copy(n.boundingBox.max).min(o.max).sub(o.min),s.x=Math.floor(s.x*i/e),s.y=Math.floor(s.y*i/e),s.z=Math.floor(s.z*i/e)):(r.set(i,i,i),s.set(0,0,0))),new L(r,s)}function I(t,n,e,i,r){var s=t.resolution+1,o=s*s,a=r.max.x,u=r.max.y,l=r.max.z,h=void 0,c=void 0,d=void 0;for(d=r.min.z;d<=l;++d)for(c=r.min.y;c<=u;++c)for(h=r.min.x;h<=a;++h)n.updateMaterialIndex(d*o+c*s+h,e,i)}function M(t,n,e,i){var r=t.size,s=t.resolution,o=s+1,a=o*o,u=e.materialIndices,l=t.min,h=new R,c=new R,d=i.max.x,y=i.max.y,v=i.max.z,f=void 0,m=0,p=void 0,x=void 0,g=void 0;for(g=i.min.z;g<=v;++g)for(h.z=g*r/s,x=i.min.y;x<=y;++x)for(h.y=x*r/s,p=i.min.x;p<=d;++p)h.x=p*r/s,(f=n.generateMaterialIndex(c.addVectors(l,h)))!==nt.AIR&&(u[g*a+x*o+p]=f,++m);e.materials=m}function S(t,n,e,i){var r=t.resolution+1,s=new Uint32Array([1,r,r*r]),o=e.materialIndices,a=new ct,u=new ct,l=i.edgeData,h=e.edgeData,c=At.calculate1DEdgeCount(t.resolution),d=new At(Math.min(c,h.edges[0].length+l.edges[0].length),Math.min(c,h.edges[1].length+l.edges[1].length),Math.min(c,h.edges[2].length+l.edges[2].length)),y=new Uint32Array(3),v=void 0,f=void 0,m=void 0,p=void 0,x=void 0,g=void 0,k=void 0,w=void 0,b=void 0,z=void 0,A=void 0,U=void 0,I=void 0,M=void 0,S=void 0,O=void 0,_=void 0,D=void 0,P=void 0,E=void 0,C=void 0,T=void 0;for(_=0,D=0;D<3;_=0,++D){for(v=l.edges[D],p=h.edges[D],k=d.edges[D],f=l.zeroCrossings[D],x=h.zeroCrossings[D],w=d.zeroCrossings[D],m=l.normals[D],g=h.normals[D],b=d.normals[D],C=v.length,T=p.length,P=0,E=0;P<C;++P)if(z=v[P],A=z+s[D],M=o[z],S=o[A],M!==S&&(M===nt.AIR||S===nt.AIR)){for(a.t=f[P],a.n.x=m[3*P],a.n.y=m[3*P+1],a.n.z=m[3*P+2],n.type===Dt.DIFFERENCE&&a.n.negate(),O=a;E<T&&p[E]<=z;)I=(U=p[E])+s[D],u.t=x[E],u.n.x=g[3*E],u.n.y=g[3*E+1],u.n.z=g[3*E+2],M=o[U],U<z?M===(S=o[I])||M!==nt.AIR&&S!==nt.AIR||(k[_]=U,w[_]=u.t,b[3*_]=u.n.x,b[3*_+1]=u.n.y,b[3*_+2]=u.n.z,++_):O=n.selectEdge(u,a,M===nt.SOLID),++E;k[_]=z,w[_]=O.t,b[3*_]=O.n.x,b[3*_+1]=O.n.y,b[3*_+2]=O.n.z,++_}for(;E<T;)I=(U=p[E])+s[D],(M=o[U])===(S=o[I])||M!==nt.AIR&&S!==nt.AIR||(k[_]=U,w[_]=x[E],b[3*_]=g[3*E],b[3*_+1]=g[3*E+1],b[3*_+2]=g[3*E+2],++_),++E;y[D]=_}return{edgeData:d,lengths:y}}function O(t,n,e,i){var r=t.size,s=t.resolution,o=s+1,a=o*o,u=new Uint32Array([1,o,a]),l=e.materialIndices,h=t.min,c=new R,d=new R,y=new ct,v=new At(At.calculate1DEdgeCount(s)),f=new Uint32Array(3),m=void 0,p=void 0,x=void 0,g=void 0,k=void 0,w=void 0,b=void 0,z=void 0,A=void 0,U=void 0,I=void 0,M=void 0,S=void 0,O=void 0,_=void 0,D=void 0,P=void 0,E=void 0;for(O=4,M=0,S=0;S<3;O>>=1,M=0,++S){switch(_=j[O],m=v.edges[S],p=v.zeroCrossings[S],x=v.normals[S],w=i.min.x,A=i.max.x,b=i.min.y,U=i.max.y,z=i.min.z,I=i.max.z,S){case 0:w=Math.max(w-1,0),A=Math.min(A,s-1);break;case 1:b=Math.max(b-1,0),U=Math.min(U,s-1);break;case 2:z=Math.max(z-1,0),I=Math.min(I,s-1)}for(E=z;E<=I;++E)for(P=b;P<=U;++P)for(D=w;D<=A;++D)k=(g=E*a+P*o+D)+u[S],l[g]!==l[k]&&(c.set(D*r/s,P*r/s,E*r/s),d.set((D+_[0])*r/s,(P+_[1])*r/s,(E+_[2])*r/s),y.a.addVectors(h,c),y.b.addVectors(h,d),n.generateEdge(y),m[M]=g,p[M]=y.t,x[3*M]=y.n.x,x[3*M+1]=y.n.y,x[3*M+2]=y.n.z,++M);f[S]=M}return{edgeData:v,lengths:f}}function _(t,n,e,i){var r=U(t,n),s=void 0,o=void 0,a=void 0,u=void 0,l=!1;if(n.type===Dt.DENSITY_FUNCTION?M(t,n,e,r):e.empty?n.type===Dt.UNION&&(e.set(i),l=!0):e.full&&n.type===Dt.UNION||I(t,n,e,i,r),!l&&!e.empty&&!e.full){for(o=(s=n.type===Dt.DENSITY_FUNCTION?O(t,n,e,r):S(t,n,e,i)).edgeData,a=s.lengths,u=0;u<3;++u)o.edges[u]=o.edges[u].slice(0,a[u]),o.zeroCrossings[u]=o.zeroCrossings[u].slice(0,a[u]),o.normals[u]=o.normals[u].slice(0,3*a[u]);e.edgeData=o}}function D(t,n){var e=n.children,i=void 0,r=void 0,s=void 0,o=void 0;for(n.type===Dt.DENSITY_FUNCTION&&_(t,n,i=new Mt),s=0,o=e.length;s<o&&(r=D(t,e[s]),void 0===i?i=r:null!==r?null===i?n.type===Dt.UNION&&(i=r):_(t,n,i,r):n.type===Dt.INTERSECTION&&(i=null),null!==i||n.type===Dt.UNION);++s);return null!==i&&i.empty?null:i}var P=function(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")},E=function(){function t(t,n){for(var e=0;e<n.length;e++){var i=n[e];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(n,e,i){return e&&t(n.prototype,e),i&&t(n,i),n}}(),C=function t(n,e,i){null===n&&(n=Function.prototype);var r=Object.getOwnPropertyDescriptor(n,e);if(void 0===r){var s=Object.getPrototypeOf(n);return null===s?void 0:t(s,e,i)}if("value"in r)return r.value;var o=r.get;if(void 0!==o)return o.call(i)},T=function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);t.prototype=Object.create(n&&n.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(t,n):t.__proto__=n)},N=function(t,n){if(!t)throw new ReferenceError("this hasn\'t been initialised - super() hasn\'t been called");return!n||"object"!=typeof n&&"function"!=typeof n?t:n},F=function(t){if(Array.isArray(t)){for(var n=0,e=Array(t.length);n<t.length;n++)e[n]=t[n];return e}return Array.from(t)},R=(function(){function t(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;P(this,t),this.x=n,this.y=e}E(t,[{key:"set",value:function(t,n){return this.x=t,this.y=n,this}},{key:"copy",value:function(t){return this.x=t.x,this.y=t.y,this}},{key:"fromArray",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return this.x=t[n],this.y=t[n+1],this}},{key:"toArray",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return t[n]=this.x,t[n+1]=this.y,t}},{key:"equals",value:function(t){return t.x===this.x&&t.y===this.y}},{key:"clone",value:function(){return new this.constructor(this.x,this.y)}},{key:"add",value:function(t){return this.x+=t.x,this.y+=t.y,this}},{key:"addScaledVector",value:function(t,n){return this.x+=t.x*n,this.y+=t.y*n,this}},{key:"addScalar",value:function(t){return this.x+=t,this.y+=t,this}},{key:"addVectors",value:function(t,n){return this.x=t.x+n.x,this.y=t.y+n.y,this}},{key:"sub",value:function(t){return this.x-=t.x,this.y-=t.y,this}},{key:"subScalar",value:function(t){return this.x-=t,this.y-=t,this}},{key:"subVectors",value:function(t,n){return this.x=t.x-n.x,this.y=t.y-n.y,this}},{key:"multiply",value:function(t){return this.x*=t.x,this.y*=t.y,this}},{key:"multiplyScalar",value:function(t){return isFinite(t)?(this.x*=t,this.y*=t):(this.x=0,this.y=0),this}},{key:"multiplyVectors",value:function(t,n){return this.x=t.x*n.x,this.y=t.y*n.y,this}},{key:"divide",value:function(t){return this.x/=t.x,this.y/=t.y,this}},{key:"divideScalar",value:function(t){return this.multiplyScalar(1/t)}},{key:"divideVectors",value:function(t,n){return this.x=t.x/n.x,this.y=t.y/n.y,this}},{key:"negate",value:function(){return this.x=-this.x,this.y=-this.y,this}},{key:"dot",value:function(t){return this.x*t.x+this.y*t.y}},{key:"lengthSq",value:function(){return this.x*this.x+this.y*this.y}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y)}},{key:"distanceTo",value:function(t){return Math.sqrt(this.distanceToSquared(t))}},{key:"distanceToSquared",value:function(t){var n=this.x-t.x,e=this.y-t.y;return n*n+e*e}},{key:"normalize",value:function(){return this.divideScalar(this.length())}},{key:"min",value:function(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this}},{key:"max",value:function(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this}},{key:"clamp",value:function(t,n){return this.x=Math.max(t.x,Math.min(n.x,this.x)),this.y=Math.max(t.y,Math.min(n.y,this.y)),this}}])}(),function(){function t(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;P(this,t),this.x=n,this.y=e,this.z=i}return E(t,[{key:"set",value:function(t,n,e){return this.x=t,this.y=n,this.z=e,this}},{key:"copy",value:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}},{key:"fromArray",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return this.x=t[n],this.y=t[n+1],this.z=t[n+2],this}},{key:"toArray",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return t[n]=this.x,t[n+1]=this.y,t[n+2]=this.z,t}},{key:"equals",value:function(t){return t.x===this.x&&t.y===this.y&&t.z===this.z}},{key:"clone",value:function(){return new this.constructor(this.x,this.y,this.z)}},{key:"add",value:function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}},{key:"addScaledVector",value:function(t,n){return this.x+=t.x*n,this.y+=t.y*n,this.z+=t.z*n,this}},{key:"addScalar",value:function(t){return this.x+=t,this.y+=t,this.z+=t,this}},{key:"addVectors",value:function(t,n){return this.x=t.x+n.x,this.y=t.y+n.y,this.z=t.z+n.z,this}},{key:"sub",value:function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}},{key:"subScalar",value:function(t){return this.x-=t,this.y-=t,this.z-=t,this}},{key:"subVectors",value:function(t,n){return this.x=t.x-n.x,this.y=t.y-n.y,this.z=t.z-n.z,this}},{key:"multiply",value:function(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}},{key:"multiplyScalar",value:function(t){return isFinite(t)?(this.x*=t,this.y*=t,this.z*=t):(this.x=0,this.y=0,this.z=0),this}},{key:"multiplyVectors",value:function(t,n){return this.x=t.x*n.x,this.y=t.y*n.y,this.z=t.z*n.z,this}},{key:"divide",value:function(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}},{key:"divideScalar",value:function(t){return this.multiplyScalar(1/t)}},{key:"divideVectors",value:function(t,n){return this.x=t.x/n.x,this.y=t.y/n.y,this.z=t.z/n.z,this}},{key:"negate",value:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}},{key:"dot",value:function(t){return this.x*t.x+this.y*t.y+this.z*t.z}},{key:"lengthSq",value:function(){return this.x*this.x+this.y*this.y+this.z*this.z}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}},{key:"distanceTo",value:function(t){return Math.sqrt(this.distanceToSquared(t))}},{key:"distanceToSquared",value:function(t){var n=this.x-t.x,e=this.y-t.y,i=this.z-t.z;return n*n+e*e+i*i}},{key:"normalize",value:function(){return this.divideScalar(this.length())}},{key:"min",value:function(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this}},{key:"max",value:function(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this}},{key:"clamp",value:function(t,n){return this.x=Math.max(t.x,Math.min(n.x,this.x)),this.y=Math.max(t.y,Math.min(n.y,this.y)),this.z=Math.max(t.z,Math.min(n.z,this.z)),this}},{key:"applyMatrix3",value:function(t){var n=this.x,e=this.y,i=this.z,r=t.elements;return this.x=r[0]*n+r[3]*e+r[6]*i,this.y=r[1]*n+r[4]*e+r[7]*i,this.z=r[2]*n+r[5]*e+r[8]*i,this}},{key:"applyMatrix4",value:function(t){var n=this.x,e=this.y,i=this.z,r=t.elements;return this.x=r[0]*n+r[4]*e+r[8]*i+r[12],this.y=r[1]*n+r[5]*e+r[9]*i+r[13],this.z=r[2]*n+r[6]*e+r[10]*i+r[14],this}}]),t}()),L=function(){function t(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new R(1/0,1/0,1/0),e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new R(-1/0,-1/0,-1/0);P(this,t),this.min=n,this.max=e}return E(t,[{key:"set",value:function(t,n){return this.min.copy(t),this.max.copy(n),this}},{key:"copy",value:function(t){return this.min.copy(t.min),this.max.copy(t.max),this}},{key:"clone",value:function(){return(new this.constructor).copy(this)}},{key:"expandByPoint",value:function(t){return this.min.min(t),this.max.max(t),this}},{key:"union",value:function(t){return this.min.min(t.min),this.max.max(t.max),this}},{key:"setFromPoints",value:function(t){var n=void 0,e=void 0;for(n=0,e=t.length;n<e;++n)this.expandByPoint(t[n]);return this}},{key:"setFromCenterAndSize",value:function(t,n){var e=n.clone().multiplyScalar(.5);return this.min.copy(t).sub(e),this.max.copy(t).add(e),this}},{key:"intersectsBox",value:function(t){return!(t.max.x<this.min.x||t.min.x>this.max.x||t.max.y<this.min.y||t.min.y>this.max.y||t.max.z<this.min.z||t.min.z>this.max.z)}}]),t}(),q=function(){function t(){P(this,t),this.elements=new Float32Array([1,0,0,0,1,0,0,0,1])}return E(t,[{key:"set",value:function(t,n,e,i,r,s,o,a,u){var l=this.elements;return l[0]=t,l[3]=n,l[6]=e,l[1]=i,l[4]=r,l[7]=s,l[2]=o,l[5]=a,l[8]=u,this}},{key:"identity",value:function(){return this.set(1,0,0,0,1,0,0,0,1),this}},{key:"copy",value:function(t){var n=t.elements;return this.set(n[0],n[3],n[6],n[1],n[4],n[7],n[2],n[5],n[8])}},{key:"clone",value:function(){return(new this.constructor).copy(this)}}]),t}(),B=function(){function t(){P(this,t),this.elements=new Float32Array([1,0,0,1,0,1])}return E(t,[{key:"set",value:function(t,n,e,i,r,s){var o=this.elements;return o[0]=t,o[1]=n,o[3]=i,o[2]=e,o[4]=r,o[5]=s,this}},{key:"identity",value:function(){return this.set(1,0,0,1,0,1),this}},{key:"copy",value:function(t){var n=t.elements;return this.set(n[0],n[1],n[2],n[3],n[4],n[5]),this}},{key:"clone",value:function(){return(new this.constructor).copy(this)}},{key:"toMatrix3",value:function(t){var n=t.elements;t.set(n[0],n[1],n[2],n[1],n[3],n[4],n[2],n[4],n[5])}},{key:"add",value:function(t){var n=this.elements,e=t.elements;return n[0]+=e[0],n[1]+=e[1],n[3]+=e[3],n[2]+=e[2],n[4]+=e[4],n[5]+=e[5],this}},{key:"norm",value:function(){var t=this.elements,n=t[1]*t[1],e=t[2]*t[2],i=t[4]*t[4];return Math.sqrt(t[0]*t[0]+n+e+n+t[3]*t[3]+i+e+i+t[5]*t[5])}},{key:"off",value:function(){var t=this.elements;return Math.sqrt(2*(t[1]*t[1]+t[2]*t[2]+t[4]*t[4]))}},{key:"applyToVector3",value:function(t){var n=t.x,e=t.y,i=t.z,r=this.elements;return t.x=r[0]*n+r[1]*e+r[2]*i,t.y=r[1]*n+r[3]*e+r[4]*i,t.z=r[2]*n+r[4]*e+r[5]*i,t}}],[{key:"calculateIndex",value:function(t,n){return 3-(3-t)*(2-t)/2+n}}]),t}(),V=function(){function t(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new R,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new R;P(this,t),this.min=n,this.max=e,this.children=null}return E(t,[{key:"getCenter",value:function(){return this.min.clone().add(this.max).multiplyScalar(.5)}},{key:"getDimensions",value:function(){return this.max.clone().sub(this.min)}},{key:"split",value:function(t){var n=this.min,e=this.max,i=this.getCenter(),r=void 0,s=void 0,o=0,a=void 0,u=void 0,l=void 0,h=void 0,c=void 0;for(Array.isArray(t)&&(u=this.getDimensions().multiplyScalar(.5),l=[new R,new R,new R],o=t.length),this.children=[],r=0;r<8;++r){if(a=j[r],c=null,o>0)for(l[1].addVectors(n,l[0].fromArray(a).multiply(u)),l[2].addVectors(i,l[0].fromArray(a).multiply(u)),s=0;s<o;++s)if(null!==(h=t[s])&&l[1].equals(h.min)&&l[2].equals(h.max)){c=h,t[s]=null;break}this.children.push(null!==c?c:new this.constructor(new R(0===a[0]?n.x:i.x,0===a[1]?n.y:i.y,0===a[2]?n.z:i.z),new R(0===a[0]?i.x:e.x,0===a[1]?i.y:e.y,0===a[2]?i.z:e.z)))}}}]),t}(),j=[new Uint8Array([0,0,0]),new Uint8Array([0,0,1]),new Uint8Array([0,1,0]),new Uint8Array([0,1,1]),new Uint8Array([1,0,0]),new Uint8Array([1,0,1]),new Uint8Array([1,1,0]),new Uint8Array([1,1,1])],H=[new Uint8Array([0,4]),new Uint8Array([1,5]),new Uint8Array([2,6]),new Uint8Array([3,7]),new Uint8Array([0,2]),new Uint8Array([1,3]),new Uint8Array([4,6]),new Uint8Array([5,7]),new Uint8Array([0,1]),new Uint8Array([2,3]),new Uint8Array([4,5]),new Uint8Array([6,7])],Y=function(){function t(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new R,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;P(this,t),this.min=n,this.size=e,this.children=null}return E(t,[{key:"getCenter",value:function(){return this.min.clone().addScalar(.5*this.size)}},{key:"getDimensions",value:function(){return new R(this.size,this.size,this.size)}},{key:"split",value:function(t){var n=this.min,e=this.getCenter(),i=.5*this.size,r=void 0,s=void 0,o=0,a=void 0,u=void 0,l=void 0,h=void 0;for(Array.isArray(t)&&(u=new R,o=t.length),this.children=[],r=0;r<8;++r){if(a=j[r],h=null,o>0)for(u.fromArray(a).multiplyScalar(i).add(n),s=0;s<o;++s)if(null!==(l=t[s])&&l.size===i&&u.equals(l.min)){h=l,t[s]=null;break}this.children.push(null!==h?h:new this.constructor(new R(0===a[0]?n.x:e.x,0===a[1]?n.y:e.y,0===a[2]?n.z:e.z),i))}}},{key:"max",get:function(){return this.min.clone().addScalar(this.size)}}]),t}(),G=function(){function t(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];P(this,t),this.value=n,this.done=e}return E(t,[{key:"reset",value:function(){this.value=null,this.done=!1}}]),t}(),X=new L,Z=function(){function t(n){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;P(this,t),this.octree=n,this.region=e,this.cull=null!==e,this.result=new G,this.trace=null,this.indices=null,this.reset()}return E(t,[{key:"reset",value:function(){var t=this.octree.root;return this.trace=[],this.indices=[],null!==t&&(X.min=t.min,X.max=t.max,this.cull&&!this.region.intersectsBox(X)||(this.trace.push(t),this.indices.push(0))),this.result.reset(),this}},{key:"next",value:function(){for(var t=this.cull,n=this.region,e=this.indices,i=this.trace,r=null,s=i.length-1,o=void 0,a=void 0,u=void 0;null===r&&s>=0;)if(o=e[s],a=i[s].children,++e[s],o<8)if(null!==a){if(u=a[o],t&&(X.min=u.min,X.max=u.max,!n.intersectsBox(X)))continue;i.push(u),e.push(0),++s}else r=i.pop(),e.pop();else i.pop(),e.pop(),--s;return this.result.value=r,this.result.done=null===r,this.result}},{key:"return",value:function(t){return this.result.value=t,this.result.done=!0,this.result}},{key:Symbol.iterator,value:function(){return this}}]),t}(),J=new Uint8Array([0,1,2,3,4,5,6,7,0]),K=[new Uint8Array([4,2,1]),new Uint8Array([5,3,8]),new Uint8Array([6,8,3]),new Uint8Array([7,8,8]),new Uint8Array([8,6,5]),new Uint8Array([8,7,8]),new Uint8Array([8,8,7]),new Uint8Array([8,8,8])],Q=function(){function t(){P(this,t)}return E(t,null,[{key:"intersectOctree",value:function(t,n,i){var r=t.getDimensions(),s=r.clone().multiplyScalar(.5),o=t.min.clone().sub(t.min),a=t.max.clone().sub(t.min),u=n.ray.direction.clone(),l=n.ray.origin.clone();l.sub(t.getCenter()).add(s);var h=void 0,c=void 0,d=void 0,y=void 0,v=void 0,f=void 0,m=void 0,p=void 0,x=void 0;J[8]=J[0],u.x<0&&(l.x=r.x-l.x,u.x=-u.x,J[8]|=J[4]),u.y<0&&(l.y=r.y-l.y,u.y=-u.y,J[8]|=J[2]),u.z<0&&(l.z=r.z-l.z,u.z=-u.z,J[8]|=J[1]),h=1/u.x,c=1/u.y,d=1/u.z,y=(o.x-l.x)*h,v=(a.x-l.x)*h,f=(o.y-l.y)*c,m=(a.y-l.y)*c,p=(o.z-l.z)*d,x=(a.z-l.z)*d,Math.max(Math.max(y,f),p)<Math.min(Math.min(v,m),x)&&e(t.root,y,f,p,v,m,x,n,i)}}]),t}(),W=new L,$=function(){function t(n,e){P(this,t),this.root=void 0!==n&&void 0!==e?new V(n,e):null}return E(t,[{key:"getCenter",value:function(){return this.root.getCenter()}},{key:"getDimensions",value:function(){return this.root.getDimensions()}},{key:"getDepth",value:function(){return i(this.root)}},{key:"cull",value:function(t){var n=[];return r(this.root,t,n),n}},{key:"findOctantsByLevel",value:function(t){var n=[];return s(this.root,t,0,n),n}},{key:"raycast",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return Q.intersectOctree(this,t,n),n}},{key:"leaves",value:function(t){return new Z(this,t)}},{key:Symbol.iterator,value:function(){return new Z(this)}},{key:"min",get:function(){return this.root.min}},{key:"max",get:function(){return this.root.max}},{key:"children",get:function(){return this.root.children}}]),t}(),tt=function(t){function n(t,e){P(this,n);var i=N(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t,e));return i.points=null,i.data=null,i}return T(n,V),E(n,[{key:"distanceToSquared",value:function(t){return t.clone().clamp(this.min,this.max).sub(t).lengthSq()}},{key:"distanceToCenterSquared",value:function(t){var n=this.getCenter(),e=t.x-n.x,i=t.y-n.x,r=t.z-n.z;return e*e+i*i+r*r}},{key:"contains",value:function(t,n){var e=this.min,i=this.max;return t.x>=e.x-n&&t.y>=e.y-n&&t.z>=e.z-n&&t.x<=i.x+n&&t.y<=i.y+n&&t.z<=i.z+n}},{key:"redistribute",value:function(t){var n=this.children,e=this.points,i=this.data,r=void 0,s=void 0,o=void 0,a=void 0,u=void 0;if(null!==n)for(;e.length>0;)for(a=e.pop(),u=i.pop(),r=0,s=n.length;r<s;++r)if((o=n[r]).contains(a,t)){null===o.points&&(o.points=[],o.data=[]),o.points.push(a),o.data.push(u);break}this.points=null,this.data=null}},{key:"merge",value:function(){var t=this.children,n=void 0,e=void 0,i=void 0;if(null!==t){for(this.points=[],this.data=[],n=0,e=t.length;n<e;++n)if(null!==(i=t[n]).points){var r,s;(r=this.points).push.apply(r,F(i.points)),(s=this.data).push.apply(s,F(i.data))}this.children=null}}}]),n}(),nt=(function(t){function n(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:8,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:8;P(this,n);var o=N(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return o.root=new tt(t,e),o.bias=Math.max(0,i),o.biasSquared=o.bias*o.bias,o.maxPoints=Math.max(1,Math.round(r)),o.maxDepth=Math.max(0,Math.round(s)),o}T(n,$),E(n,[{key:"countPoints",value:function(){return o(this.root)}},{key:"add",value:function(t,n){a(this.root,t,n,0,this.bias,this.maxPoints,this.maxDepth)}},{key:"remove",value:function(t){u(this.root,null,t,this.bias,this.maxPoints)}},{key:"fetch",value:function(t){return l(this.root,t,this.bias,this.biasSquared)}},{key:"findNearestPoint",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1/0,e=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return h(this.root,t,n,e)}},{key:"findPoints",value:function(t,n){var e=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=[];return c(this.root,t,n,e,i),i}},{key:"raycast",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],i=C(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"raycast",this).call(this,t);return i.length>0&&this.testPoints(i,t,e),e}},{key:"testPoints",value:function(t,n,e){var i=n.params.Points.threshold,r=i*i,s=void 0,o=void 0,a=void 0,u=void 0,l=void 0,h=void 0,c=void 0,d=void 0,y=void 0,v=void 0,f=void 0;for(l=0,c=t.length;l<c;++l)if(y=t[l],null!==(v=y.points))for(h=0,d=v.length;h<d;++h)f=v[h],(u=n.ray.distanceSqToPoint(f))<r&&(s=n.ray.closestPointToPoint(f),(o=n.ray.origin.distanceTo(s))>=n.near&&o<=n.far&&(a=Math.sqrt(u),e.push({distance:o,distanceToRay:a,point:s.clone(),object:y.data[h]})))}}])}(),{AIR:0,SOLID:1}),et=function(){function t(){P(this,t),this.ata=new B,this.ata.set(0,0,0,0,0,0),this.atb=new R,this.btb=0,this.massPoint=new R,this.numPoints=0,this.massPointDimension=0}return E(t,[{key:"set",value:function(t,n,e,i,r){return this.ata.copy(t),this.atb.copy(n),this.btb=e,this.massPoint.copy(i),this.numPoints=r,this}},{key:"copy",value:function(t){return this.set(t.ata,t.atb,t.btb,t.massPoint,t.numPoints)}},{key:"add",value:function(t,n){var e=n.x,i=n.y,r=n.z,s=n.dot(t),o=this.ata.elements,a=this.atb;o[0]+=e*e,o[1]+=e*i,o[2]+=e*r,o[3]+=i*i,o[4]+=i*r,o[5]+=r*r,a.x+=s*e,a.y+=s*i,a.z+=s*r,this.btb+=s*s,this.massPoint.add(t),++this.numPoints}},{key:"addData",value:function(t){this.ata.add(t.ata),this.atb.add(t.atb),this.btb+=t.btb,this.massPoint.add(t.massPoint),this.numPoints+=t.numPoints}},{key:"clear",value:function(){this.ata.set(0,0,0,0,0,0),this.atb.set(0,0,0),this.btb=0,this.massPoint.set(0,0,0),this.numPoints=0}},{key:"clone",value:function(){return(new this.constructor).copy(this)}}]),t}(),it=function(){function t(){P(this,t)}return E(t,null,[{key:"rot01Post",value:function(t,n){var e=t.elements,i=e[0],r=e[3],s=e[1],o=e[4],a=e[2],u=e[5],l=n.c,h=n.s;e[0]=l*i-h*r,e[3]=h*i+l*r,e[1]=l*s-h*o,e[4]=h*s+l*o,e[2]=l*a-h*u,e[5]=h*a+l*u}},{key:"rot02Post",value:function(t,n){var e=t.elements,i=e[0],r=e[6],s=e[1],o=e[7],a=e[2],u=e[8],l=n.c,h=n.s;e[0]=l*i-h*r,e[6]=h*i+l*r,e[1]=l*s-h*o,e[7]=h*s+l*o,e[2]=l*a-h*u,e[8]=h*a+l*u}},{key:"rot12Post",value:function(t,n){var e=t.elements,i=e[3],r=e[6],s=e[4],o=e[7],a=e[5],u=e[8],l=n.c,h=n.s;e[3]=l*i-h*r,e[6]=h*i+l*r,e[4]=l*s-h*o,e[7]=h*s+l*o,e[5]=l*a-h*u,e[8]=h*a+l*u}}]),t}(),rt={c:0,s:0},st=function(){function t(){P(this,t)}return E(t,null,[{key:"rot01",value:function(t){var n=t.elements,e=n[0],i=n[1],r=n[2],s=n[3],o=n[4];d(e,i,s);var a=rt.c,u=rt.s,l=a*a,h=u*u,c=2*a*u*i;return n[0]=l*e-c+h*s,n[1]=0,n[2]=a*r-u*o,n[3]=h*e+c+l*s,n[4]=u*r+a*o,rt}},{key:"rot02",value:function(t){var n=t.elements,e=n[0],i=n[1],r=n[2],s=n[4],o=n[5];d(e,r,o);var a=rt.c,u=rt.s,l=a*a,h=u*u,c=2*a*u*r;return n[0]=l*e-c+h*o,n[1]=a*i-u*s,n[2]=0,n[4]=u*i+a*s,n[5]=h*e+c+l*o,rt}},{key:"rot12",value:function(t){var n=t.elements,e=n[1],i=n[2],r=n[3],s=n[4],o=n[5];d(r,s,o);var a=rt.c,u=rt.s,l=a*a,h=u*u,c=2*a*u*s;return n[1]=a*e-u*i,n[2]=u*e+a*i,n[3]=l*r-c+h*o,n[4]=0,n[5]=h*r+c+l*o,rt}}]),t}(),ot=function(){function t(){P(this,t)}return E(t,null,[{key:"solveSymmetric",value:function(t,n,e,i,r,s){var o=new q,a=new q,u=new B,l=void 0;return a.set(0,0,0,0,0,0,0,0,0),u.set(0,0,0,0,0,0),m(t,u,o,i,r),l=x(a,u,o,s),e.copy(n).applyMatrix3(a),l}},{key:"calculateError",value:function(t,n,e){var i=t.elements,r=e.clone(),s=new q;return s.set(i[0],i[1],i[2],i[1],i[3],i[4],i[2],i[4],i[5]),r.applyMatrix3(s),r.subVectors(n,r),r.lengthSq()}}]),t}(),at=function(){function t(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e-6,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e-6;P(this,t),this.svdThreshold=n,this.svdSweeps=e,this.pseudoInverseThreshold=i,this.data=null,this.massPoint=new R,this.ata=new B,this.atb=new R,this.x=new R,this.hasSolution=!1}return E(t,[{key:"computeError",value:function(){var t=this.x,n=1/0,e=void 0;return this.hasSolution&&(e=this.ata.applyToVector3(t.clone()),n=t.dot(e)-2*t.dot(this.atb)+this.data.btb),n}},{key:"setData",value:function(t){return this.data=t,this.hasSolution=!1,this}},{key:"solve",value:function(){var t=this.data,n=this.massPoint,e=this.ata,i=this.atb,r=this.x,s=void 0;return!this.hasSolution&&null!==t&&t.numPoints>0&&(n.copy(t.massPoint),n.divideScalar(t.numPoints),e.copy(t.ata),i.copy(t.atb),s=e.applyToVector3(n.clone()),i.sub(s),r.set(0,0,0),t.massPointDimension=ot.solveSymmetric(e,i,r,this.svdThreshold,this.svdSweeps,this.pseudoInverseThreshold),r.add(n),i.copy(t.atb),this.hasSolution=!0),r}},{key:"clear",value:function(){this.data=null,this.hasSolution=!1}}]),t}(),ut=new R,lt=new R,ht=new R,ct=function(){function t(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new R,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new R;P(this,t),this.a=n,this.b=e,this.t=0,this.n=new R}return E(t,[{key:"approximateZeroCrossing",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:8,e=Math.max(1,n-1),i=0,r=1,s=0,o=0,a=void 0,u=void 0;for(ut.subVectors(this.b,this.a);o<=e&&(s=(i+r)/2,lt.addVectors(this.a,ht.copy(ut).multiplyScalar(s)),u=t.sample(lt),!(Math.abs(u)<=.01||(r-i)/2<=1e-6));)lt.addVectors(this.a,ht.copy(ut).multiplyScalar(i)),a=t.sample(lt),Math.sign(u)===Math.sign(a)?i=s:r=s,++o;this.t=s}},{key:"computeZeroCrossingPosition",value:function(){return ut.subVectors(this.b,this.a).multiplyScalar(this.t).add(this.a)}},{key:"computeSurfaceNormal",value:function(t){var n=this.computeZeroCrossingPosition(),e=.001,i=t.sample(lt.addVectors(n,ht.set(e,0,0)))-t.sample(lt.subVectors(n,ht.set(e,0,0))),r=t.sample(lt.addVectors(n,ht.set(0,e,0)))-t.sample(lt.subVectors(n,ht.set(0,e,0))),s=t.sample(lt.addVectors(n,ht.set(0,0,e)))-t.sample(lt.subVectors(n,ht.set(0,0,e)));this.n.set(i,r,s).normalize()}}]),t}(),dt=function t(){P(this,t),this.materials=0,this.edgeCount=0,this.index=-1,this.position=new R,this.normal=new R,this.qefData=null},yt=0,vt=function(t){function n(t,e){P(this,n);var i=N(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t,e));return i.voxel=null,i}return T(n,Y),E(n,[{key:"contains",value:function(t){var n=this.min,e=this.size;return t.x>=n.x-1e-6&&t.y>=n.y-1e-6&&t.z>=n.z-1e-6&&t.x<=n.x+e+1e-6&&t.y<=n.y+e+1e-6&&t.z<=n.z+e+1e-6}},{key:"collapse",value:function(){var t=this.children,n=new Int16Array([-1,-1,-1,-1,-1,-1,-1,-1]),e=-1,i=null!==t,r=0,s=void 0,o=void 0,a=void 0,u=void 0,l=void 0,h=void 0,c=void 0,d=void 0;if(i){for(s=new et,c=0,d=0;d<8;++d)r+=(a=t[d]).collapse(),l=a.voxel,null!==a.children?i=!1:null!==l&&(s.addData(l.qefData),e=l.materials>>7-d&1,n[d]=l.materials>>d&1,++c);if(i&&(o=new at,h=o.setData(s).solve(),o.computeError()<=yt)){for((l=new dt).position.copy(this.contains(h)?h:o.massPoint),d=0;d<8;++d)u=n[d],a=t[d],-1===u?l.materials|=e<<d:(l.materials|=u<<d,l.normal.add(a.voxel.normal));l.normal.normalize(),l.qefData=s,this.voxel=l,this.children=null,r+=c-1}}return r}},{key:"lod",get:function(){return yt},set:function(t){yt=.01+t*t*t}}]),n}(),ft=function(t){function n(t){P(this,n);var e=N(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return e.root=new vt(t.min,t.size),e.root.lod=t.data.lod,e.voxelCount=0,e.construct(t),e.simplify(),e}return T(n,$),E(n,[{key:"simplify",value:function(){this.voxelCount-=this.root.collapse()}},{key:"getCell",value:function(t,n,e,i){var r=this.root,s=0;for(t>>=1;t>0;t>>=1,s=0)n>=t&&(s+=4,n-=t),e>=t&&(s+=2,e-=t),i>=t&&(s+=1,i-=t),null===r.children&&r.split(),r=r.children[s];return r}},{key:"construct",value:function(t){var n=t.size,e=t.resolution,i=e+1,r=i*i,s=t.data,o=s.edgeData,a=s.materialIndices,u=new at,l=t.min,h=new R,c=new R,d=new R,y=new ct,v=[new Uint8Array([0,1,2,3]),new Uint8Array([0,1,4,5]),new Uint8Array([0,2,4,6])],f=0,m=void 0,p=void 0,x=void 0,k=void 0,w=void 0,b=void 0,z=void 0,A=void 0,U=void 0,I=void 0,M=void 0,S=void 0,O=void 0,_=void 0,D=void 0,P=void 0,E=void 0,C=void 0,T=void 0,N=void 0,F=void 0;for(I=4,M=0;M<3;++M,I>>=1)for(A=j[I],m=o.edges[M],p=o.zeroCrossings[M],x=o.normals[M],k=v[M],S=0,_=m.length;S<_;++S)for(C=(F=m[S])%i,T=Math.trunc(F%r/i),N=Math.trunc(F/r),h.set(C*n/e,T*n/e,N*n/e),c.set((C+A[0])*n/e,(T+A[1])*n/e,(N+A[2])*n/e),y.a.addVectors(l,h),y.b.addVectors(l,c),y.t=p[S],y.n.fromArray(x,3*S),d.copy(y.computeZeroCrossingPosition()),O=0;O<4;++O)D=C-(w=j[k[O]])[0],P=T-w[1],E=N-w[2],D>=0&&P>=0&&E>=0&&D<e&&P<e&&E<e&&(null===(U=this.getCell(e,D,P,E)).voxel&&(U.voxel=g(e,D,P,E,a),++f),(b=U.voxel).normal.add(y.n),b.qefData.add(d,y.n),b.qefData.numPoints===b.edgeCount&&(z=u.setData(b.qefData).solve(),b.position.copy(U.contains(z)?z:u.massPoint),b.normal.normalize()));this.voxelCount=f}}]),n}(),mt=[new Uint8Array([0,4,0]),new Uint8Array([1,5,0]),new Uint8Array([2,6,0]),new Uint8Array([3,7,0]),new Uint8Array([0,2,1]),new Uint8Array([4,6,1]),new Uint8Array([1,3,1]),new Uint8Array([5,7,1]),new Uint8Array([0,1,2]),new Uint8Array([2,3,2]),new Uint8Array([4,5,2]),new Uint8Array([6,7,2])],pt=[new Uint8Array([0,1,2,3,0]),new Uint8Array([4,5,6,7,0]),new Uint8Array([0,4,1,5,1]),new Uint8Array([2,6,3,7,1]),new Uint8Array([0,2,4,6,2]),new Uint8Array([1,3,5,7,2])],xt=[[new Uint8Array([4,0,0]),new Uint8Array([5,1,0]),new Uint8Array([6,2,0]),new Uint8Array([7,3,0])],[new Uint8Array([2,0,1]),new Uint8Array([6,4,1]),new Uint8Array([3,1,1]),new Uint8Array([7,5,1])],[new Uint8Array([1,0,2]),new Uint8Array([3,2,2]),new Uint8Array([5,4,2]),new Uint8Array([7,6,2])]],gt=[[new Uint8Array([1,4,0,5,1,1]),new Uint8Array([1,6,2,7,3,1]),new Uint8Array([0,4,6,0,2,2]),new Uint8Array([0,5,7,1,3,2])],[new Uint8Array([0,2,3,0,1,0]),new Uint8Array([0,6,7,4,5,0]),new Uint8Array([1,2,0,6,4,2]),new Uint8Array([1,3,1,7,5,2])],[new Uint8Array([1,1,0,3,2,0]),new Uint8Array([1,5,4,7,6,0]),new Uint8Array([0,1,5,0,4,1]),new Uint8Array([0,3,7,2,6,1])]],kt=[[new Uint8Array([3,2,1,0,0]),new Uint8Array([7,6,5,4,0])],[new Uint8Array([5,1,4,0,1]),new Uint8Array([7,3,6,2,1])],[new Uint8Array([6,4,2,0,2]),new Uint8Array([7,5,3,1,2])]],wt=[new Uint8Array([3,2,1,0]),new Uint8Array([7,5,6,4]),new Uint8Array([11,10,9,8])],bt=function(){function t(){P(this,t)}return E(t,null,[{key:"run",value:function(t){var n=[],e=new ft(t),i=e.voxelCount,r=null,s=null,o=null;return i>65536?console.warn("Could not create geometry for chunk at position",this.chunk.min,"with lod",this.chunk.data.lod,"(vertex count of",i,"exceeds limit of 65536)"):i>0&&(s=new Float32Array(3*i),o=new Float32Array(3*i),A(e.root,s,o,0),z(e.root,n),r={indices:new Uint16Array(n),positions:s,normals:o}),r}}]),t}(),zt=function(){function t(){P(this,t)}return E(t,null,[{key:"encode",value:function(t){var n=[],e=[],i=t[0],r=1,s=void 0,o=void 0;for(s=1,o=t.length;s<o;++s)i!==t[s]?(n.push(r),e.push(i),i=t[s],r=1):++r;return n.push(r),e.push(i),{runLengths:n,data:e}}},{key:"decode",value:function(t,n){var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],i=void 0,r=void 0,s=void 0,o=void 0,a=void 0,u=0;for(r=0,o=n.length;r<o;++r)for(i=n[r],s=0,a=t[r];s<a;++s)e[u++]=i;return e}}]),t}(),At=function(){function t(n){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:n,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:n;P(this,t),this.edges=[new Uint32Array(n),new Uint32Array(e),new Uint32Array(i)],this.zeroCrossings=[new Float32Array(n),new Float32Array(e),new Float32Array(i)],this.normals=[new Float32Array(3*n),new Float32Array(3*e),new Float32Array(3*i)]}return E(t,[{key:"createTransferList",value:function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=[this.edges[0],this.edges[1],this.edges[2],this.zeroCrossings[0],this.zeroCrossings[1],this.zeroCrossings[2],this.normals[0],this.normals[1],this.normals[2]],e=void 0;n.length>0;)null!==(e=n.pop())&&t.push(e.buffer);return t}},{key:"serialise",value:function(){return{edges:this.edges,zeroCrossings:this.zeroCrossings,normals:this.normals}}},{key:"deserialise",value:function(t){this.edges=t.edges,this.zeroCrossings=t.zeroCrossings,this.normals=t.normals}}],[{key:"calculate1DEdgeCount",value:function(t){return Math.pow(t+1,2)*t}}]),t}(),Ut=0,It=0,Mt=function(){function t(){var n=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];P(this,t),this.lod=-1,this.neutered=!1,this.materials=0,this.materialIndices=n?new Uint8Array(It):null,this.runLengths=null,this.edgeData=null}return E(t,[{key:"set",value:function(t){return this.lod=t.lod,this.neutered=t.neutered,this.materials=t.materials,this.materialIndices=t.materialIndices,this.runLengths=t.runLengths,this.edgeData=t.edgeData,this}},{key:"setMaterialIndex",value:function(t,n){this.materialIndices[t]===nt.AIR?n!==nt.AIR&&++this.materials:n===nt.AIR&&--this.materials,this.materialIndices[t]=n}},{key:"compress",value:function(){var t=void 0;return null===this.runLengths&&(t=this.full?{runLengths:[this.materialIndices.length],data:[nt.SOLID]}:zt.encode(this.materialIndices),this.runLengths=new Uint32Array(t.runLengths),this.materialIndices=new Uint8Array(t.data)),this}},{key:"decompress",value:function(){return null!==this.runLengths&&(this.materialIndices=zt.decode(this.runLengths,this.materialIndices,new Uint8Array(It)),this.runLengths=null),this}},{key:"createTransferList",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return null!==this.edgeData&&this.edgeData.createTransferList(t),t.push(this.materialIndices.buffer),t.push(this.runLengths.buffer),t}},{key:"serialise",value:function(){return this.neutered=!0,{lod:this.lod,materials:this.materials,materialIndices:this.materialIndices,runLengths:this.runLengths,edgeData:null!==this.edgeData?this.edgeData.serialise():null}}},{key:"deserialise",value:function(t){this.lod=t.lod,this.materials=t.materials,this.materialIndices=t.materialIndices,this.runLengths=t.runLengths,null!==t.edgeData?(null===this.edgeData&&(this.edgeData=new At(0)),this.edgeData.deserialise(t.edgeData)):this.edgeData=null,this.neutered=!1}},{key:"empty",get:function(){return 0===this.materials}},{key:"full",get:function(){return this.materials===It}}],[{key:"resolution",get:function(){return Ut},set:function(t){0===Ut&&(Ut=Math.max(1,Math.min(256,t)),It=Math.pow(Ut+1,3))}}]),t}(),St=function(t){function n(t,e){P(this,n);var i=N(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t,e));return i.data=null,i.csg=null,i}return T(n,Y),E(n,[{key:"createTransferList",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return null!==this.data?this.data.createTransferList(t):t}},{key:"serialise",value:function(){return{resolution:this.resolution,min:this.min.toArray(),size:this.size,data:null!==this.data?this.data.serialise():null}}},{key:"deserialise",value:function(t){this.resolution=t.resolution,this.min.fromArray(t.min),this.size=t.size,null!==t.data?(null===this.data&&(this.data=new Mt(!1)),this.data.deserialise(t.data)):this.data=null}},{key:"resolution",get:function(){return Mt.resolution},set:function(t){Mt.resolution=t}}]),n}(),Ot={EXTRACT:"worker.extract",MODIFY:"worker.modify",CLOSE:"worker.close"},_t=function(){function t(){P(this,t),this.chunk=new St,this.message={action:Ot.EXTRACT,chunk:null,positions:null,normals:null,indices:null},this.transferList=null}return E(t,[{key:"extract",value:function(t){var n=this.message,e=[];this.chunk.deserialise(t),this.chunk.data.decompress();var i=bt.run(this.chunk);null!==i?(n.indices=i.indices,n.positions=i.positions,n.normals=i.normals,e.push(n.indices.buffer),e.push(n.positions.buffer),e.push(n.normals.buffer)):(n.indices=null,n.positions=null,n.normals=null),this.chunk.deserialise(t),n.chunk=this.chunk.serialise(),this.transferList=this.chunk.createTransferList(e)}}]),t}(),Dt={UNION:"csg.union",DIFFERENCE:"csg.difference",INTERSECTION:"csg.intersection",DENSITY_FUNCTION:"csg.densityfunction"},Pt=function(){function t(n){P(this,t),this.type=n;for(var e=arguments.length,i=Array(e>1?e-1:0),r=1;r<e;r++)i[r-1]=arguments[r];this.children=i,this.bbox=null}return E(t,[{key:"computeBoundingBox",value:function(){var t=this.children,n=void 0,e=void 0;for(this.bbox=new L,n=0,e=t.length;n<e;++n)this.bbox.union(t[n].boundingBox);return this.bbox}},{key:"boundingBox",get:function(){return null!==this.bbox?this.bbox:this.computeBoundingBox()}}]),t}(),Et=function(t){function n(){var t;P(this,n);for(var e=arguments.length,i=Array(e),r=0;r<e;r++)i[r]=arguments[r];return N(this,(t=n.__proto__||Object.getPrototypeOf(n)).call.apply(t,[this,Dt.UNION].concat(i)))}return T(n,Pt),E(n,[{key:"updateMaterialIndex",value:function(t,n,e){var i=e.materialIndices[t];i!==nt.AIR&&n.setMaterialIndex(t,i)}},{key:"selectEdge",value:function(t,n,e){return e?t.t>n.t?t:n:t.t<n.t?t:n}}]),n}(),Ct=function(t){function n(){var t;P(this,n);for(var e=arguments.length,i=Array(e),r=0;r<e;r++)i[r]=arguments[r];return N(this,(t=n.__proto__||Object.getPrototypeOf(n)).call.apply(t,[this,Dt.DIFFERENCE].concat(i)))}return T(n,Pt),E(n,[{key:"updateMaterialIndex",value:function(t,n,e){e.materialIndices[t]!==nt.AIR&&n.setMaterialIndex(t,nt.AIR)}},{key:"selectEdge",value:function(t,n,e){return e?t.t<n.t?t:n:t.t>n.t?t:n}}]),n}(),Tt=function(t){function n(){var t;P(this,n);for(var e=arguments.length,i=Array(e),r=0;r<e;r++)i[r]=arguments[r];return N(this,(t=n.__proto__||Object.getPrototypeOf(n)).call.apply(t,[this,Dt.INTERSECTION].concat(i)))}return T(n,Pt),E(n,[{key:"updateMaterialIndex",value:function(t,n,e){var i=e.materialIndices[t];n.setMaterialIndex(t,n.materialIndices[t]!==nt.AIR&&i!==nt.AIR?i:nt.AIR)}},{key:"selectEdge",value:function(t,n,e){return e?t.t<n.t?t:n:t.t>n.t?t:n}}]),n}(),Nt=function(){function t(){P(this,t)}return E(t,null,[{key:"run",value:function(t,n){null===t.data?n.operation===Dt.UNION&&(t.data=new Mt,t.data.edgeData=new At(0)):t.data.decompress();var e=n.toCSG(),i=null!==t.data?D(t,e):null;if(null!==i){switch(n.operation){case Dt.UNION:e=new Et(e);break;case Dt.DIFFERENCE:e=new Ct(e);break;case Dt.INTERSECTION:e=new Tt(e)}_(t,e,t.data,i),t.data.lod=-1}null!==t.data&&(t.data.empty?t.data=null:t.data.compress())}}]),t}(),Ft={SPHERE:"sdf.sphere",BOX:"sdf.box",TORUS:"sdf.torus",PLANE:"sdf.plane",HEIGHTFIELD:"sdf.heightfield"},Rt=function(t){function n(t){P(this,n);var e=N(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,Dt.DENSITY_FUNCTION));return e.sdf=t,e}return T(n,Pt),E(n,[{key:"computeBoundingBox",value:function(){return this.bbox=this.sdf.computeBoundingBox(),this.bbox}},{key:"generateMaterialIndex",value:function(t){return this.sdf.sample(t)<=0?this.sdf.material:nt.AIR}},{key:"generateEdge",value:function(t){t.approximateZeroCrossing(this.sdf),t.computeSurfaceNormal(this.sdf)}}]),n}(),Lt=function(){function t(n){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:nt.SOLID;P(this,t),this.type=n,this.operation=null,this.material=Math.min(255,Math.max(nt.SOLID,Math.trunc(e))),this.children=[],this.bbox=null}return E(t,[{key:"union",value:function(t){return t.operation=Dt.UNION,this.children.push(t),this}},{key:"subtract",value:function(t){return t.operation=Dt.DIFFERENCE,this.children.push(t),this}},{key:"intersect",value:function(t){return t.operation=Dt.INTERSECTION,this.children.push(t),this}},{key:"serialise",value:function(){var t={type:this.type,operation:this.operation,material:this.material,parameters:null,children:[]},n=this.children,e=void 0,i=void 0;for(e=0,i=n.length;e<i;++e)t.children.push(n[e].serialise());return t}},{key:"toCSG",value:function(){var t=this.children,n=new Rt(this),e=void 0,i=void 0,r=void 0,s=void 0;for(r=0,s=t.length;r<s;++r){if(i=t[r],e!==i.operation)switch(e=i.operation){case Dt.UNION:n=new Et(n);break;case Dt.DIFFERENCE:n=new Ct(n);break;case Dt.INTERSECTION:n=new Tt(n)}n.children.push(i.toCSG())}return n}},{key:"computeBoundingBox",value:function(){throw new Error("SDF: bounding box method not implemented!")}},{key:"sample",value:function(t){throw new Error("SDF: sample method not implemented!")}},{key:"boundingBox",get:function(){return null!==this.bbox?this.bbox:this.computeBoundingBox()}},{key:"completeBoundingBox",get:function(){var t=this.children,n=this.boundingBox.clone(),e=void 0,i=void 0;for(e=0,i=t.length;e<i;++e)n.union(t[e].completeBoundingBox);return n}}]),t}(),qt=function(t){function n(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments[1];P(this,n);var i=N(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,Ft.SPHERE,e));return i.origin=new(Function.prototype.bind.apply(R,[null].concat(F(t.origin)))),i.radius=t.radius,i}return T(n,Lt),E(n,[{key:"computeBoundingBox",value:function(){return this.bbox=new L,this.bbox.min.copy(this.origin).subScalar(this.radius),this.bbox.max.copy(this.origin).addScalar(this.radius),this.bbox}},{key:"sample",value:function(t){var n=this.origin,e=t.x-n.x,i=t.y-n.y,r=t.z-n.z;return Math.sqrt(e*e+i*i+r*r)-this.radius}},{key:"serialise",value:function(){var t=C(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"serialise",this).call(this);return t.parameters={origin:this.origin.toArray(),radius:this.radius},t}}]),n}(),Bt=function(t){function n(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments[1];P(this,n);var i=N(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,Ft.BOX,e));return i.origin=new(Function.prototype.bind.apply(R,[null].concat(F(t.origin)))),i.halfDimensions=new(Function.prototype.bind.apply(R,[null].concat(F(t.halfDimensions)))),i}return T(n,Lt),E(n,[{key:"computeBoundingBox",value:function(){return this.bbox=new L,this.bbox.min.subVectors(this.origin,this.halfDimensions),this.bbox.max.addVectors(this.origin,this.halfDimensions),this.bbox}},{key:"sample",value:function(t){var n=this.origin,e=this.halfDimensions,i=Math.abs(t.x-n.x)-e.x,r=Math.abs(t.y-n.y)-e.y,s=Math.abs(t.z-n.z)-e.z,o=Math.max(i,Math.max(r,s)),a=Math.max(i,0),u=Math.max(r,0),l=Math.max(s,0),h=Math.sqrt(a*a+u*u+l*l);return Math.min(o,0)+h}},{key:"serialise",value:function(){var t=C(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"serialise",this).call(this);return t.parameters={origin:this.origin.toArray(),halfDimensions:this.halfDimensions.toArray()},t}}]),n}(),Vt=function(t){function n(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments[1];P(this,n);var i=N(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,Ft.PLANE,e));return i.normal=new(Function.prototype.bind.apply(R,[null].concat(F(t.normal)))),i.constant=t.constant,i}return T(n,Lt),E(n,[{key:"computeBoundingBox",value:function(){return this.bbox=new L,this.bbox}},{key:"sample",value:function(t){return this.normal.dot(t)+this.constant}},{key:"serialise",value:function(){var t=C(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"serialise",this).call(this);return t.parameters={normal:this.normal.toArray(),constant:this.constant},t}}]),n}(),jt=function(t){function n(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments[1];P(this,n);var i=N(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,Ft.TORUS,e));return i.origin=new(Function.prototype.bind.apply(R,[null].concat(F(t.origin)))),i.R=t.R,i.r=t.r,i}return T(n,Lt),E(n,[{key:"computeBoundingBox",value:function(){return this.bbox=new L,this.bbox.min.copy(this.origin).subScalar(this.R).subScalar(this.r),this.bbox.max.copy(this.origin).addScalar(this.R).addScalar(this.r),this.bbox}},{key:"sample",value:function(t){var n=this.origin,e=t.x-n.x,i=t.y-n.y,r=t.z-n.z,s=Math.sqrt(e*e+r*r)-this.R;return Math.sqrt(s*s+i*i)-this.r}},{key:"serialise",value:function(){var t=C(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"serialise",this).call(this);return t.parameters={origin:this.origin.toArray(),R:this.R,r:this.r},t}}]),n}(),Ht=function(t){function n(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments[1];P(this,n);var i=N(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,Ft.HEIGHTFIELD,e));return i.min=new(Function.prototype.bind.apply(R,[null].concat(F(t.min)))),i.dimensions=new(Function.prototype.bind.apply(R,[null].concat(F(t.size)))),i.data=t.data,i}return T(n,Lt),E(n,[{key:"computeBoundingBox",value:function(){return this.bbox=new L,this.bbox.min.copy(this.min),this.bbox.max.addVectors(this.min,this.dimensions),this.bbox}},{key:"sample",value:function(t){var n=this.min,e=this.dimensions,i=Math.max(n.x,Math.min(n.x+e.x,t.x-n.x)),r=Math.max(n.z,Math.min(n.z+e.z,t.z-n.z));return t.y-n.y-this.data[r*e.x+i]/255*e.y}},{key:"serialise",value:function(){var t=C(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"serialise",this).call(this);return t.parameters={min:this.min.toArray(),dimensions:this.dimensions.toArray(),data:this.data},t}}]),n}(),Yt=function(){function t(){P(this,t)}return E(t,null,[{key:"reviveSDF",value:function(t){var n=void 0,e=void 0,i=void 0;switch(t.type){case Ft.SPHERE:n=new qt(t.parameters,t.material);break;case Ft.BOX:n=new Bt(t.parameters,t.material);break;case Ft.TORUS:n=new jt(t.parameters,t.material);break;case Ft.PLANE:n=new Vt(t.parameters,t.material);break;case Ft.HEIGHTFIELD:n=new Ht(t.parameters,t.material)}for(n.operation=t.operation,e=0,i=t.children.length;e<i;++e)n.children.push(this.reviveSDF(t.children[e]));return n}}]),t}(),Gt=function(){function t(){P(this,t),this.chunk=new St,this.message={action:Ot.MODIFY,chunk:null},this.transferList=null}return E(t,[{key:"modify",value:function(t,n){this.chunk.deserialise(t),Nt.run(this.chunk,Yt.reviveSDF(n)),this.message.chunk=this.chunk.serialise(),this.transferList=this.chunk.createTransferList()}}]),t}(),Xt=new _t,Zt=new Gt;self.addEventListener("message",function(t){var n=t.data;switch(n.action){case Ot.EXTRACT:Xt.extract(n.chunk),postMessage(Xt.message,Xt.transferList);break;case Ot.MODIFY:Zt.modify(n.chunk,n.sdf),postMessage(Zt.message,Zt.transferList);break;case Ot.CLOSE:default:close()}}),self.addEventListener("error",function(t){var n={action:Ot.CLOSE,error:t.message,chunk:null},e=[],i=[Xt.chunk,Zt.chunk],r=null===i[0].data||i[0].data.neutered?null===i[1].data||i[1].data.neutered?null:r[1]:r[0];null!==r&&(n.chunk=r.serialise(),r.createTransferList(e)),postMessage(n,e),close()})}();',Tt=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:navigator.hardwareConcurrency;O(this,e);var n=N(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return n.workerURL=URL.createObjectURL(new Blob([Nt],{type:"text/javascript"})),n.maxWorkers=Math.min(navigator.hardwareConcurrency,Math.max(t,1)),n.workers=[],n.busyWorkers=new WeakSet,n}return C(e,Y),D(e,[{key:"handleEvent",value:function(t){switch(t.type){case"message":this.busyWorkers.delete(t.target),Ct.worker=t.target,Ct.data=t.data,this.dispatchEvent(Ct);break;case"error":console.error("Encountered an unexpected error.",t.message)}}},{key:"closeWorker",value:function(t){var e=this.workers.indexOf(t);this.busyWorkers.has(t)?(this.busyWorkers.delete(t),t.terminate()):t.postMessage({action:Dt.CLOSE}),t.removeEventListener("message",this),t.removeEventListener("error",this),e>=0&&this.workers.splice(e,1)}},{key:"createWorker",value:function(){var t=new Worker(this.workerURL);return this.workers.push(t),t.addEventListener("message",this),t.addEventListener("error",this),t}},{key:"getWorker",value:function(){var t=null,e=void 0,n=void 0;for(e=0,n=this.workers.length;e<n;++e)if(!this.busyWorkers.has(this.workers[e])){t=this.workers[e],this.busyWorkers.add(t);break}return null===t&&this.workers.length<this.maxWorkers&&null!==this.workerURL&&(t=this.createWorker(),this.busyWorkers.add(t)),t}},{key:"clear",value:function(){for(;this.workers.length>0;)this.closeWorker(this.workers.pop())}},{key:"dispose",value:function(){this.clear(),URL.revokeObjectURL(this.workerURL),this.workerURL=null}}]),e}(),Rt=function(t){function e(t,n,i){O(this,e);var r=N(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,i));return r.action=t,r.chunk=n,r}return C(e,j),e}(),Lt=function(t){function e(t){O(this,e);var n=N(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n.chunk=null,n}return C(e,q),e}(),Ft=new Lt("modificationstart"),Bt=new Lt("modificationend"),Vt=new Lt("extractionstart"),jt=new Lt("extractionend"),qt=new e.Box3,Yt=new e.Matrix4,Ht=function(t){function n(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};O(this,n);var i=N(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return i.object=new e.Object3D,i.object.name="Terrain",i.volume=new gt(t.chunkSize,t.resolution),i.iterator=i.volume.leaves(new e.Frustum),i.levels=void 0!==t.levels?Math.max(1,t.levels):Math.log2(i.volume.resolution),i.iterations=void 0!==t.iterations?Math.max(1,t.iterations):1e3,i.threadPool=new Tt(t.workers),i.threadPool.addEventListener("message",i),i.scheduler=new V(i.levels+1),i.history=new R,i.neutered=new WeakSet,i.chunks=new WeakMap,i.meshes=new WeakMap,i.material=new X,i}return C(n,Y),D(n,[{key:"unlinkMesh",value:function(t){var e=void 0;this.meshes.has(t)&&((e=this.meshes.get(t)).geometry.dispose(),this.meshes.delete(t),this.object.remove(e))}},{key:"handleEvent",value:function(t){var e=t.worker,n=t.data,i=this.chunks.get(e);this.neutered.delete(i),this.chunks.delete(e),i.deserialise(n.chunk),null===i.data&&null===i.csg?(this.scheduler.cancel(i),this.volume.prune(i),this.unlinkMesh(i)):null!==i.csg&&this.scheduler.schedule(i,new Rt(Dt.MODIFY,i,this.scheduler.maxPriority)),n.action!==Dt.CLOSE?(n.action===Dt.EXTRACT?(t=jt,this.consolidate(i,n)):t=Bt,t.chunk=i,this.dispatchEvent(t)):console.error(n.error),this.runNextTask()}},{key:"consolidate",value:function(t,n){var i=n.positions,r=n.normals,s=n.indices,a=void 0,o=void 0;null!==i&&null!==r&&null!==s&&(this.unlinkMesh(t),(a=new e.BufferGeometry).setIndex(new e.BufferAttribute(s,1)),a.addAttribute("position",new e.BufferAttribute(i,3)),a.addAttribute("normal",new e.BufferAttribute(r,3)),a.computeBoundingSphere(),o=new e.Mesh(a,this.material),this.meshes.set(t,o),this.object.add(o))}},{key:"runNextTask",value:function(){var t=void 0,e=void 0,n=void 0,i=void 0;null!==this.scheduler.peek()&&null!==(e=this.threadPool.getWorker())&&(n=(t=this.scheduler.poll()).chunk,t.action===Dt.MODIFY?(i=Ft,e.postMessage({action:t.action,chunk:n.serialise(),sdf:n.csg.poll().serialise()},n.createTransferList()),0===n.csg.size&&(n.csg=null)):(i=Vt,e.postMessage({action:t.action,chunk:n.serialise()},n.createTransferList())),i.chunk=n,this.neutered.add(n),this.chunks.set(e,n),this.dispatchEvent(i))}},{key:"edit",value:function(t){var e=this.volume.edit(t),n=void 0,i=!0,r=!1,s=void 0;try{for(var a,o=e[Symbol.iterator]();!(i=(a=o.next()).done);i=!0)null===(n=a.value).csg&&(n.csg=new L),n.csg.add(t)}catch(t){r=!0,s=t}finally{try{!i&&o.return&&o.return()}finally{if(r)throw s}}this.iterator.reset(),this.history.push(t)}},{key:"union",value:function(t){t.operation=U.UNION,this.edit(t)}},{key:"subtract",value:function(t){t.operation=U.DIFFERENCE,this.edit(t)}},{key:"intersect",value:function(t){t.operation=U.INTERSECTION,this.edit(t)}},{key:"update",value:function(t){var e=this.iterator,n=this.scheduler,i=n.maxPriority,r=this.levels,s=r-1,a=this.iterations,o=void 0,u=void 0,l=void 0,h=void 0,c=void 0,d=void 0,v=void 0;for(e.region.setFromMatrix(Yt.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse)),v=e.next();!v.done&&(o=v.value,u=o.data,l=o.csg,this.neutered.has(o)||(void 0===(h=n.getTask(o))||h.priority<i)&&(null!==l?(n.schedule(o,new Rt(Dt.MODIFY,o,i)),this.runNextTask()):null!==u&&(c=qt.copy(o).distanceToPoint(t.position),d=Math.min(s,Math.trunc(c/t.far*r)),u.lod!==d&&(u.lod=d,n.schedule(o,new Rt(Dt.EXTRACT,o,s-u.lod)),this.runNextTask()))),--a>0);)v=e.next();v.done&&this.iterator.reset()}},{key:"raycast",value:function(t){var e=this.meshes,n=[],i=[],r=void 0,s=void 0,a=void 0;for(this.volume.raycast(t,n),s=0,a=n.length;s<a;++s)r=n[s],e.has(r)&&(i=i.concat(t.intersectObject(e.get(r))));return i}},{key:"clearMeshes",value:function(){for(var t=this.object,e=void 0;t.children.length>0;)(e=t.children[0]).geometry.dispose(),e.material.dispose(),t.remove(e);this.meshes=new WeakMap}},{key:"clear",value:function(){this.clearMeshes(),this.volume=new gt(this.volume.chunkSize,this.volume.resolution),this.iterator=this.volume.leaves(new e.Frustum),this.neutered=new WeakSet,this.chunks=new WeakMap,this.threadPool.clear(),this.scheduler.clear(),this.history.clear()}},{key:"dispose",value:function(){this.clearMeshes(),this.threadPool.dispose()}},{key:"save",value:function(){var t=this.history.combine();return null===t?null:URL.createObjectURL(new Blob([JSON.stringify(t.serialise())],{type:"text/json"}))}},{key:"load",value:function(t){this.clear(),this.edit(Ot.reviveSDF(JSON.parse(t)))}}]),n}(),Zt=new W,Xt=new W,Wt=new W,Gt=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new W,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new W;O(this,t),this.a=e,this.b=n,this.t=0,this.n=new W}return D(t,[{key:"approximateZeroCrossing",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:8,n=Math.max(1,e-1),i=0,r=1,s=0,a=0,o=void 0,u=void 0;for(Zt.subVectors(this.b,this.a);a<=n&&(s=(i+r)/2,Xt.addVectors(this.a,Wt.copy(Zt).multiplyScalar(s)),u=t.sample(Xt),!(Math.abs(u)<=.01||(r-i)/2<=1e-6));)Xt.addVectors(this.a,Wt.copy(Zt).multiplyScalar(i)),o=t.sample(Xt),Math.sign(u)===Math.sign(o)?i=s:r=s,++a;this.t=s}},{key:"computeZeroCrossingPosition",value:function(){return Zt.subVectors(this.b,this.a).multiplyScalar(this.t).add(this.a)}},{key:"computeSurfaceNormal",value:function(t){var e=this.computeZeroCrossingPosition(),n=.001,i=t.sample(Xt.addVectors(e,Wt.set(n,0,0)))-t.sample(Xt.subVectors(e,Wt.set(n,0,0))),r=t.sample(Xt.addVectors(e,Wt.set(0,n,0)))-t.sample(Xt.subVectors(e,Wt.set(0,n,0))),s=t.sample(Xt.addVectors(e,Wt.set(0,0,n)))-t.sample(Xt.subVectors(e,Wt.set(0,0,n)));this.n.set(i,r,s).normalize()}}]),t}(),Jt=function(t){function n(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,i=arguments[1],r=arguments[2];O(this,n);var s=N(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return s.name="ChunkHelper",s.chunk=t,s.add(new e.Object3D),s.add(new e.Object3D),s.add(new e.Object3D),s.gridPoints.name="GridPoints",s.edges.name="Edges",s.normals.name="Normals",s.update(i,r),s}return C(n,t),D(n,[{key:"update",value:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=this.chunk;this.dispose(),null!==n&&null!==n.data&&(n.data.decompress(),t&&this.createPoints(n),e&&this.createEdges(n),n.data.compress())}},{key:"createPoints",value:function(t){var n=t.size,i=t.resolution,r=t.data.materialIndices,s=t.min,a=new e.Vector3,o=new e.Vector3,u=new Float32Array([0,0,0]),l=new e.PointsMaterial({vertexColors:e.VertexColors,sizeAttenuation:!1,size:3}),h=new e.BufferGeometry,c=t.data.materials,d=new Float32Array(3*c),v=new Float32Array(3*c),f=void 0,y=void 0,m=void 0,p=void 0,g=void 0;for(p=0,g=0,m=0;m<=i;++m)for(a.z=m*n/i,y=0;y<=i;++y)for(a.y=y*n/i,f=0;f<=i;++f)a.x=f*n/i,r[p++]!==ct.AIR&&(o.addVectors(s,a),d[g]=o.x,v[g++]=u[0],d[g]=o.y,v[g++]=u[1],d[g]=o.z,v[g++]=u[2]);h.addAttribute("position",new e.BufferAttribute(d,3)),h.addAttribute("color",new e.BufferAttribute(v,3)),this.gridPoints.add(new e.Points(h,l))}},{key:"createEdges",value:function(t){var n=t.size,i=t.resolution,r=i+1,s=r*r,a=t.data.edgeData,o=t.min,u=new e.Vector3,l=new e.Vector3,h=new e.Vector3,c=new e.Vector3,d=new Gt,v=[new Float32Array([.6,0,0]),new Float32Array([0,.6,0]),new Float32Array([0,0,.6])],f=new Float32Array([0,1,1]),y=new e.LineBasicMaterial({vertexColors:e.VertexColors}),m=void 0,p=void 0,g=void 0,x=void 0,k=void 0,b=void 0,w=void 0,_=void 0,z=void 0,A=void 0,M=void 0,S=void 0,E=void 0,P=void 0,U=void 0,O=void 0,D=void 0,I=void 0,C=void 0,N=void 0,T=void 0;for(P=4,E=0;E<3;++E,P>>=1){for(M=K[P],m=a.edges[E],p=a.zeroCrossings[E],g=a.normals[E],z=v[E],_=2*m.length,x=new Float32Array(3*_),k=new Float32Array(3*_),b=new Float32Array(3*_),w=new Float32Array(3*_),U=0,O=0,D=0,I=m.length;U<I;++U)C=(S=m[U])%r,N=Math.trunc(S%s/r),T=Math.trunc(S/s),u.set(C*n/i,N*n/i,T*n/i),l.set((C+M[0])*n/i,(N+M[1])*n/i,(T+M[2])*n/i),d.a.addVectors(o,u),d.b.addVectors(o,l),x[O]=d.a.x,k[O++]=z[0],x[O]=d.a.y,k[O++]=z[1],x[O]=d.a.z,k[O++]=z[2],x[O]=d.b.x,k[O++]=z[0],x[O]=d.b.y,k[O++]=z[1],x[O]=d.b.z,k[O++]=z[2],d.t=p[U],d.n.fromArray(g,3*U),h.copy(d.computeZeroCrossingPosition()),c.copy(h).addScaledVector(d.n,.25*n/i),b[D]=h.x,w[D++]=f[0],b[D]=h.y,w[D++]=f[1],b[D]=h.z,w[D++]=f[2],b[D]=c.x,w[D++]=f[0],b[D]=c.y,w[D++]=f[1],b[D]=c.z,w[D++]=f[2];(A=new e.BufferGeometry).addAttribute("position",new e.BufferAttribute(x,3)),A.addAttribute("color",new e.BufferAttribute(k,3)),this.edges.add(new e.LineSegments(A,y)),(A=new e.BufferGeometry).addAttribute("position",new e.BufferAttribute(b,3)),A.addAttribute("color",new e.BufferAttribute(w,3)),this.normals.add(new e.LineSegments(A,y))}}},{key:"dispose",value:function(){var t=void 0,e=void 0,n=void 0,i=void 0,r=void 0,s=void 0;for(n=0,r=this.children.length;n<r;++n){for(i=0,s=(e=(t=this.children[n]).children).length;i<s;++i)e[i].geometry.dispose(),e[i].material.dispose();for(;e.length>0;)t.remove(e[0])}}},{key:"gridPoints",get:function(){return this.children[0]}},{key:"edges",get:function(){return this.children[1]}},{key:"normals",get:function(){return this.children[2]}}]),n}(e.Object3D),Qt=function(){function t(){O(this,t)}return D(t,null,[{key:"rot01Post",value:function(t,e){var n=t.elements,i=n[0],r=n[3],s=n[1],a=n[4],o=n[2],u=n[5],l=e.c,h=e.s;n[0]=l*i-h*r,n[3]=h*i+l*r,n[1]=l*s-h*a,n[4]=h*s+l*a,n[2]=l*o-h*u,n[5]=h*o+l*u}},{key:"rot02Post",value:function(t,e){var n=t.elements,i=n[0],r=n[6],s=n[1],a=n[7],o=n[2],u=n[8],l=e.c,h=e.s;n[0]=l*i-h*r,n[6]=h*i+l*r,n[1]=l*s-h*a,n[7]=h*s+l*a,n[2]=l*o-h*u,n[8]=h*o+l*u}},{key:"rot12Post",value:function(t,e){var n=t.elements,i=n[3],r=n[6],s=n[4],a=n[7],o=n[5],u=n[8],l=e.c,h=e.s;n[3]=l*i-h*r,n[6]=h*i+l*r,n[4]=l*s-h*a,n[7]=h*s+l*a,n[5]=l*o-h*u,n[8]=h*o+l*u}}]),t}(),$t={c:0,s:0},Kt=function(){function t(){O(this,t)}return D(t,null,[{key:"rot01",value:function(t){var e=t.elements,n=e[0],i=e[1],r=e[2],s=e[3],a=e[4];y(n,i,s);var o=$t.c,u=$t.s,l=o*o,h=u*u,c=2*o*u*i;return e[0]=l*n-c+h*s,e[1]=0,e[2]=o*r-u*a,e[3]=h*n+c+l*s,e[4]=u*r+o*a,$t}},{key:"rot02",value:function(t){var e=t.elements,n=e[0],i=e[1],r=e[2],s=e[4],a=e[5];y(n,r,a);var o=$t.c,u=$t.s,l=o*o,h=u*u,c=2*o*u*r;return e[0]=l*n-c+h*a,e[1]=o*i-u*s,e[2]=0,e[4]=u*i+o*s,e[5]=h*n+c+l*a,$t}},{key:"rot12",value:function(t){var e=t.elements,n=e[1],i=e[2],r=e[3],s=e[4],a=e[5];y(r,s,a);var o=$t.c,u=$t.s,l=o*o,h=u*u,c=2*o*u*s;return e[1]=o*n-u*i,e[2]=u*n+o*i,e[3]=l*r-c+h*a,e[4]=0,e[5]=h*r+c+l*a,$t}}]),t}(),te=function(){function t(){O(this,t)}return D(t,null,[{key:"solveSymmetric",value:function(t,e,n,i,r,s){var a=new J,o=new J,u=new Q,l=void 0;return o.set(0,0,0,0,0,0,0,0,0),u.set(0,0,0,0,0,0),x(t,u,a,i,r),l=b(o,u,a,s),n.copy(e).applyMatrix3(o),l}},{key:"calculateError",value:function(t,e,n){var i=t.elements,r=n.clone(),s=new J;return s.set(i[0],i[1],i[2],i[1],i[3],i[4],i[2],i[4],i[5]),r.applyMatrix3(s),r.subVectors(e,r),r.lengthSq()}}]),t}(),ee=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e-6,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e-6;O(this,t),this.svdThreshold=e,this.svdSweeps=n,this.pseudoInverseThreshold=i,this.data=null,this.massPoint=new W,this.ata=new Q,this.atb=new W,this.x=new W,this.hasSolution=!1}return D(t,[{key:"computeError",value:function(){var t=this.x,e=1/0,n=void 0;return this.hasSolution&&(n=this.ata.applyToVector3(t.clone()),e=t.dot(n)-2*t.dot(this.atb)+this.data.btb),e}},{key:"setData",value:function(t){return this.data=t,this.hasSolution=!1,this}},{key:"solve",value:function(){var t=this.data,e=this.massPoint,n=this.ata,i=this.atb,r=this.x,s=void 0;return!this.hasSolution&&null!==t&&t.numPoints>0&&(e.copy(t.massPoint),e.divideScalar(t.numPoints),n.copy(t.ata),i.copy(t.atb),s=n.applyToVector3(e.clone()),i.sub(s),r.set(0,0,0),t.massPointDimension=te.solveSymmetric(n,i,r,this.svdThreshold,this.svdSweeps,this.pseudoInverseThreshold),r.add(e),i.copy(t.atb),this.hasSolution=!0),r}},{key:"clear",value:function(){this.data=null,this.hasSolution=!1}}]),t}(),ne=function(){function t(){O(this,t),this.ata=new Q,this.ata.set(0,0,0,0,0,0),this.atb=new W,this.btb=0,this.massPoint=new W,this.numPoints=0,this.massPointDimension=0}return D(t,[{key:"set",value:function(t,e,n,i,r){return this.ata.copy(t),this.atb.copy(e),this.btb=n,this.massPoint.copy(i),this.numPoints=r,this}},{key:"copy",value:function(t){return this.set(t.ata,t.atb,t.btb,t.massPoint,t.numPoints)}},{key:"add",value:function(t,e){var n=e.x,i=e.y,r=e.z,s=e.dot(t),a=this.ata.elements,o=this.atb;a[0]+=n*n,a[1]+=n*i,a[2]+=n*r,a[3]+=i*i,a[4]+=i*r,a[5]+=r*r,o.x+=s*n,o.y+=s*i,o.z+=s*r,this.btb+=s*s,this.massPoint.add(t),++this.numPoints}},{key:"addData",value:function(t){this.ata.add(t.ata),this.atb.add(t.atb),this.btb+=t.btb,this.massPoint.add(t.massPoint),this.numPoints+=t.numPoints}},{key:"clear",value:function(){this.ata.set(0,0,0,0,0,0),this.atb.set(0,0,0),this.btb=0,this.massPoint.set(0,0,0),this.numPoints=0}},{key:"clone",value:function(){return(new this.constructor).copy(this)}}]),t}(),ie=function t(){O(this,t),this.materials=0,this.edgeCount=0,this.index=-1,this.position=new W,this.normal=new W,this.qefData=null},re=0,se=function(t){function e(t,n){O(this,e);var i=N(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n));return i.voxel=null,i}return C(e,et),D(e,[{key:"contains",value:function(t){var e=this.min,n=this.size;return t.x>=e.x-1e-6&&t.y>=e.y-1e-6&&t.z>=e.z-1e-6&&t.x<=e.x+n+1e-6&&t.y<=e.y+n+1e-6&&t.z<=e.z+n+1e-6}},{key:"collapse",value:function(){var t=this.children,e=new Int16Array([-1,-1,-1,-1,-1,-1,-1,-1]),n=-1,i=null!==t,r=0,s=void 0,a=void 0,o=void 0,u=void 0,l=void 0,h=void 0,c=void 0,d=void 0;if(i){for(s=new ne,c=0,d=0;d<8;++d)r+=(o=t[d]).collapse(),l=o.voxel,null!==o.children?i=!1:null!==l&&(s.addData(l.qefData),n=l.materials>>7-d&1,e[d]=l.materials>>d&1,++c);if(i&&(a=new ee,h=a.setData(s).solve(),a.computeError()<=re)){for((l=new ie).position.copy(this.contains(h)?h:a.massPoint),d=0;d<8;++d)u=e[d],o=t[d],-1===u?l.materials|=n<<d:(l.materials|=u<<d,l.normal.add(o.voxel.normal));l.normal.normalize(),l.qefData=s,this.voxel=l,this.children=null,r+=c-1}}return r}},{key:"lod",get:function(){return re},set:function(t){re=.01+t*t*t}}]),e}(),ae=function(t){function e(t){O(this,e);var n=N(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return n.root=new se(t.min,t.size),n.root.lod=t.data.lod,n.voxelCount=0,n.construct(t),n.simplify(),n}return C(e,lt),D(e,[{key:"simplify",value:function(){this.voxelCount-=this.root.collapse()}},{key:"getCell",value:function(t,e,n,i){var r=this.root,s=0;for(t>>=1;t>0;t>>=1,s=0)e>=t&&(s+=4,e-=t),n>=t&&(s+=2,n-=t),i>=t&&(s+=1,i-=t),null===r.children&&r.split(),r=r.children[s];return r}},{key:"construct",value:function(t){var e=t.size,n=t.resolution,i=n+1,r=i*i,s=t.data,a=s.edgeData,o=s.materialIndices,u=new ee,l=t.min,h=new W,c=new W,d=new W,v=new Gt,f=[new Uint8Array([0,1,2,3]),new Uint8Array([0,1,4,5]),new Uint8Array([0,2,4,6])],y=0,m=void 0,p=void 0,g=void 0,x=void 0,k=void 0,b=void 0,_=void 0,z=void 0,A=void 0,M=void 0,S=void 0,E=void 0,P=void 0,U=void 0,O=void 0,D=void 0,I=void 0,C=void 0,N=void 0,T=void 0,R=void 0;for(M=4,S=0;S<3;++S,M>>=1)for(z=K[M],m=a.edges[S],p=a.zeroCrossings[S],g=a.normals[S],x=f[S],E=0,U=m.length;E<U;++E)for(C=(R=m[E])%i,N=Math.trunc(R%r/i),T=Math.trunc(R/r),h.set(C*e/n,N*e/n,T*e/n),c.set((C+z[0])*e/n,(N+z[1])*e/n,(T+z[2])*e/n),v.a.addVectors(l,h),v.b.addVectors(l,c),v.t=p[E],v.n.fromArray(g,3*E),d.copy(v.computeZeroCrossingPosition()),P=0;P<4;++P)O=C-(k=K[x[P]])[0],D=N-k[1],I=T-k[2],O>=0&&D>=0&&I>=0&&O<n&&D<n&&I<n&&(null===(A=this.getCell(n,O,D,I)).voxel&&(A.voxel=w(n,O,D,I,o),++y),(b=A.voxel).normal.add(v.n),b.qefData.add(d,v.n),b.qefData.numPoints===b.edgeCount&&(_=u.setData(b.qefData).solve(),b.position.copy(A.contains(_)?_:u.massPoint),b.normal.normalize()));this.voxelCount=y}}]),e}(),oe=function(){function t(){O(this,t)}return D(t,null,[{key:"run",value:function(t,e){null===t.data?e.operation===U.UNION&&(t.data=new yt,t.data.edgeData=new dt(0)):t.data.decompress();var n=e.toCSG(),i=null!==t.data?P(t,n):null;if(null!==i){switch(e.operation){case U.UNION:n=new bt(n);break;case U.DIFFERENCE:n=new wt(n);break;case U.INTERSECTION:n=new _t(n)}E(t,n,t.data,i),t.data.lod=-1}null!==t.data&&(t.data.empty?t.data=null:t.data.compress())}}]),t}();t.History=R,t.PriorityQueue=F,t.Queue=L,t.RunLengthEncoder=B,t.Scheduler=V,t.Task=j,t.Terrain=Ht,t.TerrainEvent=Lt,t.WorkerEvent=It,t.ChunkHelper=Jt,t.MeshTriplanarPhysicalMaterial=X,t.Givens=Qt,t.QEFSolver=ee,t.QEFData=ne,t.Schur=Kt,t.SingularValueDecomposition=te,t.Edge=Gt,t.EdgeData=dt,t.HermiteData=yt,t.Material=ct,t.Voxel=ie,t.Chunk=mt,t.Volume=gt,t.VoxelBlock=ae,t.VoxelCell=se,t.SignedDistanceFunction=At,t.Heightfield=Ut,t.Sphere=Mt,t.Torus=Pt,t.Plane=Et,t.Box=St,t.ConstructiveSolidGeometry=oe,t.Intersection=_t,t.Difference=wt,t.Union=bt,Object.defineProperty(t,"__esModule",{value:!0})});